# Issue #001: 学校基本情報画面の実装（図書室管理・クラス管理を含む）

## 概要

画面設計仕様書の「5.2 学校の基本情報画面（図書室管理・クラス管理を含む）」に基づき、フロントエンドに学校基本情報画面を実装する。この画面では学校情報、役職情報、図書室情報、クラス情報を一元的に管理できるようにする。

## 現在の状況

現在のフロントエンド実装では、以下のような個別の管理画面が存在している：

- クラス管理画面 (`/frontend/src/app/classes/`)
- 図書室管理画面 (`/frontend/src/app/libraries/`)

これらの機能を統合し、学校の基本情報も含めた統合管理画面を作成する必要がある。

## 変更内容

### 新規作成ファイル

1. **学校基本情報の管理画面**
   - `/frontend/src/app/school/page.tsx` - 学校基本情報のメインページ（タブ切り替え機能を実装）
   - `/frontend/src/app/school/components/SchoolInfoForm.tsx` - 学校情報編集フォーム
   - `/frontend/src/app/school/components/PositionsTable.tsx` - 役職情報の一覧表示と編集
   - `/frontend/src/app/school/components/LibrariesTable.tsx` - 図書室情報の一覧表示と編集 
   - `/frontend/src/app/school/components/ClassesTable.tsx` - クラス情報の一覧表示と編集

2. **APIサービス拡張**
   - `/frontend/src/services/api.ts` に学校情報と役職情報のAPIインターフェースを追加

### 更新ファイル

1. **APIクライアント更新**
   - `/frontend/src/services/api.ts` - 学校情報と役職情報のAPI呼び出し関数の追加

2. **ナビゲーション更新**
   - `/frontend/src/app/layout.tsx` - 学校情報管理へのリンク追加
   - `/frontend/src/app/management/page.tsx` - 管理画面からのリンク追加

### 廃止予定ファイル

以下の個別管理画面は、統合後に段階的に廃止を検討する。ただし、当面は両方を維持して段階的に移行する。

- `/frontend/src/app/classes/` - 統合管理画面に機能移行後に廃止
- `/frontend/src/app/libraries/` - 統合管理画面に機能移行後に廃止

## 機能仕様

### 1. 学校基本情報セクション

- 学校名、前期・後期の開始日と終了日の表示と編集
- アクティブ状態の切り替え
- 保存・キャンセルボタン

### 2. 役職情報セクション

- 役職一覧表示（役職名、説明、作成日、更新日）
- 役職の追加、編集、削除機能
- 検索・フィルタリング機能

### 3. 図書室情報セクション

- 図書室一覧表示（図書室ID、図書室名、収容人数、説明、アクティブ状態）
- 図書室の追加、編集、削除機能
- 検索・フィルタリング機能

### 4. クラス情報セクション

- クラス一覧表示（学年、クラス番号、クラス名、担任教諭名、アクティブ状態）
- クラスの追加、編集、削除機能
- 学年によるフィルタリング機能

## API仕様

以下のAPIエンドポイントを実装/利用する：

### 学校情報API

```typescript
export interface School {
  id: number;
  school_name: string;
  first_term_start: string | null;
  first_term_end: string | null;
  second_term_start: string | null;
  second_term_end: string | null;
  active: boolean;
  created_at: string;
  updated_at: string;
}

export const schoolsApi = {
  getAll: () => fetchApi<School[]>('/schools'),
  getById: (id: number) => fetchApi<School>(`/schools/${id}`),
  create: (school: Omit<School, 'id' | 'created_at' | 'updated_at'>) => 
    fetchApi<School>('/schools', {
      method: 'POST',
      body: JSON.stringify(school),
    }),
  update: (id: number, school: Partial<Omit<School, 'id' | 'created_at' | 'updated_at'>>) => 
    fetchApi<School>(`/schools/${id}`, {
      method: 'PUT',
      body: JSON.stringify(school),
    }),
};
```

### 役職情報API

```typescript
export interface Position {
  id: number;
  position_name: string;
  description: string | null;
  created_at: string;
  updated_at: string;
}

export const positionsApi = {
  getAll: () => fetchApi<Position[]>('/positions'),
  getById: (id: number) => fetchApi<Position>(`/positions/${id}`),
  create: (position: Omit<Position, 'id' | 'created_at' | 'updated_at'>) => 
    fetchApi<Position>('/positions', {
      method: 'POST',
      body: JSON.stringify(position),
    }),
  update: (id: number, position: Partial<Omit<Position, 'id' | 'created_at' | 'updated_at'>>) => 
    fetchApi<Position>(`/positions/${id}`, {
      method: 'PUT',
      body: JSON.stringify(position),
    }),
  delete: (id: number) => 
    fetchApi<{ message: string }>(`/positions/${id}`, {
      method: 'DELETE',
    }),
};
```

### クラス情報API（既存のAPIを拡張）

```typescript
// 現在のインターフェースを拡張
export interface Class {
  id: number;
  school_id: number;
  grade: number;
  class_number: number;
  class_name: string;
  homeroom_teacher: string | null;
  active: boolean;
  created_at: string;
  updated_at: string;
}
```

### 図書室API（既存のAPIを拡張）

```typescript
// 現在のインターフェースを拡張
export interface Library {
  id: number;
  school_id: number;
  room_id: number;
  room_name: string;
  capacity: number;
  description: string | null;
  active: boolean;
  created_at: string;
  updated_at: string;
}
```

## バックエンド要件

バックエンド実装は別途 Issue #002 で対応する。以下のAPIエンドポイントが必要：

1. **学校情報API**
   - `GET /api/schools` - 学校情報の取得
   - `POST /api/schools` - 学校情報の新規作成
   - `PUT /api/schools/:id` - 学校情報の更新

2. **役職情報API**
   - `GET /api/positions` - 役職一覧の取得
   - `GET /api/positions/:id` - 特定の役職の取得
   - `POST /api/positions` - 役職の新規作成
   - `PUT /api/positions/:id` - 役職の更新
   - `DELETE /api/positions/:id` - 役職の削除

3. **図書室情報API（拡張）**
   - 図書室データスキーマの拡張

4. **クラス情報API（拡張）**
   - クラスデータスキーマの拡張

## 設計方針と実装ガイドライン

### 1. フォルダ構造

css_ui_framework_guidelinesに従い、以下の構造で実装する：

```
frontend/src/
  ├── app/
  │   ├── school/         # 学校管理用フォルダ
  │   │   ├── page.tsx    # メインページ
  │   │   └── components/ # 画面固有のコンポーネント
  │   ├── layout.tsx      # ルートレイアウト（ナビゲーション更新）
  │   └── management/     # 管理画面フォルダ
  ├── components/         # 再利用可能コンポーネント
  │   └── ui/             # shadcn-uiコンポーネント
  └── services/           # APIサービス
      └── api.ts          # API呼び出し関数
```

### 2. コンポーネント設計

- **単一責任の原則**
  - 各機能（学校情報、役職、クラス、図書室）は別々のコンポーネントに分離する
  - 表示と編集のロジックをそれぞれ明確に分離

- **コンポーネント間の状態管理**
  - タブ切り替え時にデータが失われないよう、必要に応じてカスタムフックを使用

- **再利用可能なコンポーネント**
  - テーブル、フォーム、モーダルなどの共通部分は再利用可能な形で設計

### 3. UI/UX設計

- **タブインターフェース**
  - 学校情報、役職、図書室、クラスの4つのセクションをタブで分割
  - shadcn-uiの`Tabs`コンポーネントを使用

- **データテーブル**
  - 検索、フィルタリング、ソートが可能なテーブルを実装
  - ページネーションの実装（大量データの場合）

- **フォーム**
  - バリデーションを含む統一されたフォームデザイン
  - エラー表示の一貫性

### 4. 技術的ガイドライン

- **TypeScriptの使用**
  - すべてのコンポーネントに型定義を行う
  - 適切なインターフェースを定義し、any型の使用を避ける

- **クライアントコンポーネント**
  - フォームやインタラクティブな要素を含むコンポーネントには`'use client'`ディレクティブを使用
  - コンポーネントの先頭に配置

- **スタイリング**
  - TailwindCSSのユーティリティクラスを使用
  - 複雑なクラス名の結合には`cn()`ユーティリティを使用
  - 一貫したスタイルで統一感を持たせる

- **エラー処理**
  - API呼び出しのエラーを適切に処理
  - ユーザーに分かりやすいエラーメッセージを表示

- **パフォーマンス最適化**
  - 大きなデータセットのロード時はスケルトンローダーを表示
  - 適切なメモ化（useMemo, useCallback）を使用

### 5. アクセシビリティ

- shadcn-uiのアクセシビリティ機能を活用
- 適切なARIA属性を使用
- キーボードナビゲーションのサポート

## テスト要件

### 1. ユニットテスト

各コンポーネントの基本機能を検証：
- レンダリングテスト
- ユーザー入力処理
- 状態更新
- エラー状態の表示

### 2. E2Eテスト

Playwrightを使用して以下のテストを実施：
- 画面遷移テスト
- CRUD操作の検証
- タブ切り替え時のデータ保持

### 3. テスト観点

- フォームバリデーション
- エラーハンドリング
- データの永続性
- レスポンシブデザイン

## 実装のポイントとレビュー観点

### 1. データ整合性

- 学校IDが他のエンティティ（クラス、図書室）に正しく関連付けられていることを確認
- 削除時の外部キー制約を考慮した処理

### 2. ユーザビリティ

- フィードバックメッセージの適切な表示
- 操作の確認（削除前の確認など）
- 一括編集機能の提供

### 3. コードレビュー観点

- **型安全性**
  - TypeScriptの適切な使用
  - インターフェースの一貫性
  - any型の不使用

- **コンポーネント設計**
  - 単一責任の原則に従っているか
  - 再利用可能なコードの適切な抽象化
  - 状態管理の適切さ

- **パフォーマンス**
  - 効率的なデータ取得
  - メモ化の適切な使用
  - 不要な再レンダリングの回避

- **エラー処理**
  - APIエラーの適切な処理
  - ユーザーフレンドリーなエラーメッセージ
  - エッジケースの考慮

- **スタイリング**
  - TailwindCSSの適切な使用
  - レスポンシブデザインの実装
  - 一貫したUIの実現

## 実装フロー

1. **APIインターフェースの拡張**
   - 学校情報と役職情報のAPIインターフェースを追加
   - クラスと図書室のインターフェースを拡張

2. **学校基本情報画面の作成**
   - タブコンポーネントを使用したメインページの実装
   - 各タブコンテンツの作成

3. **学校情報フォームの実装**
   - 学校基本情報の表示と編集フォーム
   - API連携

4. **役職管理の実装**
   - 役職一覧表示と編集機能
   - API連携

5. **図書室管理の実装**
   - 既存の図書室管理機能を新画面に統合
   - API連携

6. **クラス管理の実装**
   - 既存のクラス管理機能を新画面に統合
   - API連携

7. **ナビゲーション更新**
   - 管理画面からのリンク追加

8. **テスト実装と調整**
   - ユニットテストの作成
   - E2Eテストの作成
   - 既存画面との整合性確認

## コンポーネント詳細設計

### メインページのコンポーネント例

```tsx
'use client';

import { useState } from 'react';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { Card } from '@/components/ui/card';
import SchoolInfoForm from './components/SchoolInfoForm';
import PositionsTable from './components/PositionsTable';
import LibrariesTable from './components/LibrariesTable';
import ClassesTable from './components/ClassesTable';

export default function SchoolInfoPage() {
  const [activeTab, setActiveTab] = useState('school-info');

  return (
    <div className="container mx-auto py-6">
      <h1 className="text-3xl font-bold mb-6">学校基本情報管理</h1>
      
      <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
        <TabsList className="grid w-full grid-cols-4 mb-8">
          <TabsTrigger value="school-info">基本情報</TabsTrigger>
          <TabsTrigger value="positions">役職管理</TabsTrigger>
          <TabsTrigger value="libraries">図書室管理</TabsTrigger>
          <TabsTrigger value="classes">クラス管理</TabsTrigger>
        </TabsList>
        
        <TabsContent value="school-info">
          <Card className="p-6">
            <h2 className="text-2xl font-semibold mb-4">学校基本情報</h2>
            <SchoolInfoForm />
          </Card>
        </TabsContent>
        
        <TabsContent value="positions">
          <Card className="p-6">
            <h2 className="text-2xl font-semibold mb-4">役職管理</h2>
            <PositionsTable />
          </Card>
        </TabsContent>
        
        <TabsContent value="libraries">
          <Card className="p-6">
            <h2 className="text-2xl font-semibold mb-4">図書室管理</h2>
            <LibrariesTable />
          </Card>
        </TabsContent>
        
        <TabsContent value="classes">
          <Card className="p-6">
            <h2 className="text-2xl font-semibold mb-4">クラス管理</h2>
            <ClassesTable />
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

### データテーブルコンポーネントの例（PositionsTable）

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Position, positionsApi } from '@/services/api';
import { PlusIcon, Pencil, Trash2 } from 'lucide-react';
import { format } from 'date-fns';
import { useToast } from '@/components/ui/use-toast';

export default function PositionsTable() {
  const [positions, setPositions] = useState<Position[]>([]);
  const [loading, setLoading] = useState(true);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [currentPosition, setCurrentPosition] = useState<Position | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const { toast } = useToast();
  
  // 省略: データ取得、編集、削除などの処理
  
  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center mb-4">
        <Input
          placeholder="役職名で検索"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="max-w-sm"
        />
        <Button onClick={() => handleAdd()}>
          <PlusIcon className="mr-2 h-4 w-4" /> 新規役職
        </Button>
      </div>
      
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-[200px]">役職名</TableHead>
            <TableHead className="w-[300px]">説明</TableHead>
            <TableHead className="w-[150px]">作成日</TableHead>
            <TableHead className="w-[150px]">更新日</TableHead>
            <TableHead className="w-[100px]">操作</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {/* 役職一覧のマッピング */}
        </TableBody>
      </Table>
      
      {/* 編集ダイアログ */}
      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>
              {currentPosition ? '役職を編集' : '新規役職追加'}
            </DialogTitle>
          </DialogHeader>
          {/* フォームコンテンツ */}
          <DialogFooter>
            {/* 操作ボタン */}
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
```

## Playwrightテスト実装ガイドライン

E2Eテストは以下の手順で実装します：

### テストケース例

```typescript
import { test, expect } from '@playwright/test';

test.describe('学校基本情報画面のテスト', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン処理とテスト対象画面への遷移
    await page.goto('/login');
    await page.fill('[placeholder="ユーザー名"]', 'testuser');
    await page.fill('[placeholder="パスワード"]', 'password123');
    await page.click('button:has-text("ログイン")');
    await page.click('text=管理');
    await page.click('text=学校基本情報');
  });

  test('学校情報の表示と編集', async ({ page }) => {
    // 学校情報タブが表示されていることを確認
    await expect(page.locator('h2:has-text("学校基本情報")')).toBeVisible();
    
    // 学校名の編集
    await page.fill('input[name="school_name"]', '中央中学校');
    await page.click('button:has-text("保存")');
    
    // 保存成功メッセージの確認
    await expect(page.locator('text=保存しました')).toBeVisible();
    
    // ページをリロードして値が永続化されていることを確認
    await page.reload();
    await expect(page.locator('input[name="school_name"]')).toHaveValue('中央中学校');
  });

  test('役職情報の追加・編集・削除', async ({ page }) => {
    // 役職タブに切り替え
    await page.click('button:has-text("役職管理")');
    
    // 役職追加
    await page.click('button:has-text("新規役職")');
    await page.fill('input[name="position_name"]', 'テスト役職');
    await page.fill('textarea[name="description"]', 'テスト用の役職説明');
    await page.click('button:has-text("保存")');
    
    // 追加した役職が表示されていることを確認
    await expect(page.locator('td:has-text("テスト役職")')).toBeVisible();
    
    // 削除テスト
    await page.click('tr:has-text("テスト役職") button[aria-label="削除"]');
    await page.click('button:has-text("削除")');
    await expect(page.locator('td:has-text("テスト役職")')).not.toBeVisible();
  });
});
```

### テスト実行方法

```bash
# 特定のテストファイルを実行
npx playwright test e2e/specs/school-info-management.spec.ts

# すべてのテストを実行
npx playwright test

# GUIモードでテストを実行
npx playwright test --ui
```

### テスト結果の保存

テスト結果はYAML形式で保存し、スクリーンショットも含めます。

```yaml
testResults:
  - name: "学校基本情報画面のテスト - 学校情報の表示と編集"
    status: "passed"
    duration: 2.5
    screenshots:
      - path: "screenshots/school-info-edit.png"
        description: "学校情報編集後の画面"
  - name: "学校基本情報画面のテスト - 役職情報の追加・編集・削除"
    status: "passed"
    duration: 3.2
    screenshots:
      - path: "screenshots/position-management.png"
        description: "役職管理画面"
```

## 開発環境とコードレビュー時の注意点

### 開発環境準備

1. shadcn-uiコンポーネントのインストール
   ```bash
   npx shadcn-ui@latest add tabs
   npx shadcn-ui@latest add card
   npx shadcn-ui@latest add table
   npx shadcn-ui@latest add dialog
   npx shadcn-ui@latest add form
   npx shadcn-ui@latest add button
   npx shadcn-ui@latest add input
   npx shadcn-ui@latest add toast
   ```

2. 必要なライブラリのインストール
   ```bash
   npm install date-fns lucide-react react-hook-form zod
   ```

### コードレビューチェックリスト

- **TypeScript**
  - [ ] 適切な型定義がされているか
  - [ ] anyの使用が避けられているか
  - [ ] 未使用の変数・関数がないか

- **パフォーマンス**
  - [ ] 適切なメモ化（useMemo, useCallback）が使用されているか
  - [ ] 不要な再レンダリングが発生していないか
  - [ ] APIクエリの最適化がされているか

- **アクセシビリティ**
  - [ ] ARIA属性が適切に使用されているか
  - [ ] キーボードナビゲーションがサポートされているか
  - [ ] スクリーンリーダー対応がされているか

- **コンポーネント設計**
  - [ ] 単一責任の原則が守られているか
  - [ ] 適切な粒度でコンポーネントが分割されているか
  - [ ] 状態管理が適切に行われているか

- **UI/UX**
  - [ ] ローディング状態の表示
  - [ ] エラーメッセージの適切な表示
  - [ ] レスポンシブデザインの対応
  - [ ] ダークモード対応（任意）

## 完了条件

- 学校基本情報、役職情報、図書室情報、クラス情報を閲覧・編集できる
- データが正しくバックエンドに保存され、再表示される
- すべてのAPIエンドポイントが正常に動作する
- 必要なバリデーションが実装されている
- テストがすべてパスする
- shadcn-uiとNext.jsのベストプラクティスに従った実装
- TailwindCSSの適切な使用
- アクセシビリティ要件の充足

## 関連Issues

- Issue #002: 学校基本情報・役職情報API実装
