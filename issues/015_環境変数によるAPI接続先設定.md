# Issue #014: 環境変数によるAPI接続先設定とテスト環境管理

## 概要
現在、フロントエンドのAPI接続先がハードコーディングされているため、テストや運用で問題が発生する可能性がある。環境変数で接続先を設定できるように修正し、テスト用の起動・停止スクリプトを作成する。

## 問題点
1. フロントエンドの`api.ts`でAPIベースURLが`http://localhost:5200/api`にハードコーディングされている
2. テスト時にポート番号を変更する際、ソースコードの修正が必要
3. 開発・テスト・本番環境での切り替えが困難
4. 複数のIssueを並行してテストする場合のポート管理が手動

## 修正内容

### 1. フロントエンドの環境変数対応
- `frontend/src/services/api.ts`を修正し、環境変数`NEXT_PUBLIC_API_BASE_URL`からAPI接続先を取得
- デフォルト値として`http://localhost:5200/api`を設定
- `.env.local.example`ファイルを作成してサンプル設定を提供

### 2. 起動スクリプトの作成

#### 2.1 開発環境起動スクリプト (`scripts/dev.sh`)
```bash
#!/bin/bash
# 開発環境起動スクリプト

# バックエンド起動
cd mock_backend
source venv/bin/activate
python app.py &
BACKEND_PID=$!
cd ..

# フロントエンド起動
cd frontend
npm run dev &
FRONTEND_PID=$!
cd ..

echo "Development environment started"
echo "Backend PID: $BACKEND_PID (http://localhost:5200)"
echo "Frontend PID: $FRONTEND_PID (http://localhost:3200)"
echo "Press Ctrl+C to stop"

# 終了時の処理
trap "kill $BACKEND_PID $FRONTEND_PID" EXIT
wait
```

#### 2.2 テスト環境起動スクリプト (`scripts/test-env.sh`)
```bash
#!/bin/bash
# テスト環境起動スクリプト
# Usage: ./test-env.sh <issue_number> [start|stop]

ISSUE_NUMBER=$1
ACTION=${2:-start}

if [ -z "$ISSUE_NUMBER" ]; then
    echo "Usage: $0 <issue_number> [start|stop]"
    exit 1
fi

FRONTEND_PORT=$((3000 + ISSUE_NUMBER))
BACKEND_PORT=$((5000 + ISSUE_NUMBER))
PID_FILE=".test-env-${ISSUE_NUMBER}.pid"

start_env() {
    echo "Starting test environment for Issue #${ISSUE_NUMBER}"
    
    # バックエンド起動
    cd mock_backend
    source venv/bin/activate
    FLASK_RUN_PORT=$BACKEND_PORT python app.py &
    BACKEND_PID=$!
    cd ..
    
    # フロントエンド起動（環境変数でAPI URLを設定）
    cd frontend
    NEXT_PUBLIC_API_BASE_URL="http://localhost:${BACKEND_PORT}/api" \
    PORT=$FRONTEND_PORT npm run dev &
    FRONTEND_PID=$!
    cd ..
    
    # PIDを保存
    echo "$BACKEND_PID $FRONTEND_PID" > $PID_FILE
    
    echo "Test environment started for Issue #${ISSUE_NUMBER}"
    echo "Backend: http://localhost:${BACKEND_PORT}"
    echo "Frontend: http://localhost:${FRONTEND_PORT}"
    echo "API URL: http://localhost:${BACKEND_PORT}/api"
}

stop_env() {
    if [ -f "$PID_FILE" ]; then
        echo "Stopping test environment for Issue #${ISSUE_NUMBER}"
        read BACKEND_PID FRONTEND_PID < $PID_FILE
        kill $BACKEND_PID $FRONTEND_PID 2>/dev/null
        rm $PID_FILE
        echo "Test environment stopped"
    else
        echo "No running test environment found for Issue #${ISSUE_NUMBER}"
    fi
}

case $ACTION in
    start)
        start_env
        ;;
    stop)
        stop_env
        ;;
    *)
        echo "Invalid action. Use 'start' or 'stop'"
        exit 1
        ;;
esac
```

#### 2.3 全テスト環境停止スクリプト (`scripts/stop-all-tests.sh`)
```bash
#!/bin/bash
# すべてのテスト環境を停止

for pid_file in .test-env-*.pid; do
    if [ -f "$pid_file" ]; then
        issue_number=$(echo $pid_file | sed 's/.test-env-\(.*\).pid/\1/')
        ./scripts/test-env.sh $issue_number stop
    fi
done
```

### 3. バックエンドのポート設定対応
- `mock_backend/app.py`を修正し、環境変数`FLASK_RUN_PORT`からポート番号を取得
- デフォルト値として5200を設定

### 4. ドキュメントの更新

#### 4.1 CLAUDE.mdの更新
- 環境変数の使用方法を追記
- テスト環境起動スクリプトの使用方法を追記

#### 4.2 設計書の更新
- `docs/system_design.md`に環境変数の設定について追記
- `docs/test_strategy.md`にテスト環境管理について追記

## 実装手順
1. フロントエンドの環境変数対応
   - [ ] `api.ts`の修正
   - [ ] `.env.local.example`の作成
   - [ ] `next.config.js`の確認（環境変数の公開設定）

2. バックエンドのポート設定対応
   - [ ] `app.py`の修正

3. スクリプトの作成
   - [ ] `scripts/dev.sh`の作成
   - [ ] `scripts/test-env.sh`の作成
   - [ ] `scripts/stop-all-tests.sh`の作成
   - [ ] スクリプトに実行権限を付与

4. ドキュメントの更新
   - [ ] `CLAUDE.md`の更新
   - [ ] `docs/system_design.md`の更新
   - [ ] `docs/test_strategy.md`の更新

5. テスト
   - [ ] 開発環境起動スクリプトの動作確認
   - [ ] テスト環境起動スクリプトの動作確認（複数Issue同時起動）
   - [ ] 環境変数による接続先切り替えの確認

## 期待される効果
1. 環境に応じたAPI接続先の切り替えが容易になる
2. 複数のIssueを並行してテストできる
3. テスト環境の起動・停止が自動化される
4. ポート番号の管理が体系化される

## 注意事項
- 既存の動作に影響を与えないよう、デフォルト値を現在と同じに設定する
- スクリプトはmacOS/Linux環境を想定（Windows環境では別途対応が必要）
- テスト環境のプロセス管理にPIDファイルを使用