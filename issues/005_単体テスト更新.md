# Issue #005: 単体テスト更新（新データベーススキーマ対応）

## 概要
Issue #004で完了したバックエンドAPI更新に伴い、単体テストを新しいデータベーススキーマと更新されたAPI仕様に対応させる必要があります。現在のテストは旧スキーマ（grades、libraries等）に基づいているため、新スキーマ（schools、positions、library_rooms等）への更新と、APIレスポンス形式の変更に対応する必要があります。

## 背景
Issue #004の完了により、以下の変更が適用されています：

### データベーススキーマの変更
- **学校マスタ（schools）の導入**: 従来のgradesテーブルから学校情報を分離
- **役職マスタ（positions）の導入**: 図書委員の役職管理を追加
- **クラス構造の変更**: `grade_id` → `school_id`、`class_name`フィールドの追加
- **図書室テーブル**: `libraries` → `library_rooms`への変更
- **図書委員構造の変更**: `school_id`、`position_id`フィールドの追加

### APIエンドポイントの変更
- 新規エンドポイント: `/api/schools`、`/api/positions`
- 変更されたエンドポイント: `/api/library-rooms`（旧`/api/libraries`）
- レスポンス形式の変更: 各エンドポイントでJOIN結果を含むフィールド追加

### 現在のテストの問題点
1. **スキーマ関連**: `grade_id`フィールドを期待するテストが多数存在
2. **エンドポイント関連**: `/api/libraries`エンドポイントのテストが存在
3. **レスポンス形式**: 新しいJOINフィールド（`grade_name`、`school_name`等）に対応していない
4. **データ設定**: テスト用データが旧スキーマ形式

## 対応すべきファイル

### メインテストファイル
1. **`mock_backend/test_unit.py`** - バックエンドAPIの統合単体テスト
2. **`mock_backend/conftest.py`** - pytest設定ファイル

### 個別テストファイル（`mock_backend/tests/`配下）
3. **`test_api_classes.py`** - クラスAPI テスト
4. **`test_api_committee_members.py`** - 図書委員API テスト  
5. **`test_api_libraries.py`** - 図書室API テスト（library_roomsに変更）
6. **`test_api_schedules.py`** - スケジュールAPI テスト
7. **`test_api_schedule_assignments.py`** - スケジュール割り当てAPI テスト
8. **`test_suite.py`** - 統合テストスイート
9. **`test_db_connection.py`** - データベース接続テスト

### 新規テストファイル（作成予定）
10. **`test_api_schools.py`** - 学校API テスト
11. **`test_api_positions.py`** - 役職API テスト

### CI/CD関連
12. **`.github/workflows/mock-backend-tests.yml`** - GitHub Actions設定

## 実装状況: 🚧 進行中

### 1. テストフレームワーク・設定の更新 ⏳ 作業待ち
- [ ] `conftest.py`のテスト用データベース設定を新スキーマに対応
- [ ] テスト用データのセットアップ関数を新しいテーブル構造に更新
- [ ] テストデータベースの分離とクリーンアップ処理の改善

### 2. メインテストファイルの更新 ⏳ 作業待ち
#### `test_unit.py`の修正項目
- [ ] **学年関連テスト → 学校関連テスト**: `test_get_grades()`、`test_add_grade()`等の更新
- [ ] **クラステスト**: `grade_id`期待値を`school_id`に変更、新フィールド追加
- [ ] **図書委員テスト**: レスポンスフィールドの変更（`grade_name` → `school_name`等）
- [ ] **図書室テスト**: `/api/libraries` → `/api/library-rooms`、新フィールド対応
- [ ] **スケジュール生成テスト**: 新しいAPIパラメータとレスポンス形式への対応

### 3. 個別テストファイルの更新 ⏳ 作業待ち
#### API テストファイル
- [ ] **`test_api_classes.py`**: 
  - `grade_id`フィールド期待値を`school_id`に変更
  - `grade_name`期待値を`school_name`に変更
  - 新フィールド（`class_name`等）のテスト追加
- [ ] **`test_api_committee_members.py`**:
  - `school_id`、`position_id`フィールドのテスト追加
  - JOINフィールド（`school_name`、`position_name`等）のテスト追加
- [ ] **`test_api_libraries.py` → `test_api_library_rooms.py`**:
  - ファイル名とエンドポイントの変更
  - 新しいテーブル構造とフィールドに対応
- [ ] **`test_api_schedules.py`**:
  - `academic_year`、`school_id`等の新フィールド対応
  - スケジュール生成パラメータの変更対応
- [ ] **`test_api_schedule_assignments.py`**:
  - `library_rooms`テーブルとの関連に対応

### 4. 新規テストファイルの作成 ⏳ 作業待ち
- [ ] **`test_api_schools.py`**: 学校管理API のCRUD操作テスト
- [ ] **`test_api_positions.py`**: 役職管理API のCRUD操作テスト

### 5. 統合・その他テストの更新 ⏳ 作業待ち
- [ ] **`test_suite.py`**: 新しいテストファイルの統合、実行順序の調整
- [ ] **`test_db_connection.py`**: 新しいテーブル構造でのデータベース接続テスト
- [ ] **GitHub Actions**: 新しいテストファイルの実行設定

### 6. テストデータの更新 ⏳ 作業待ち
- [ ] テスト用初期データを新スキーマ形式に変更
- [ ] `setUp`/`tearDown`メソッドで新しいテーブル構造に対応
- [ ] テストデータの整合性確保（外部キー制約対応）

### 7. テスト仕様書の更新 ⏳ 作業待ち
- [ ] **`docs/mock_backend_test_specification.md`**: 新API仕様に合わせたテスト項目の更新
- [ ] テストサンプルデータの新スキーマ対応

## 完了条件
1. **全テストが新スキーマで正常実行される**
2. **新規APIエンドポイント（schools、positions）のテストが追加される**
3. **修正されたAPIエンドポイント（library-rooms等）のテストが更新される**
4. **テストカバレッジが80%以上を維持する**
5. **CI/CDパイプラインで全テストが成功する**
6. **レスポンス形式の変更が全テストに反映される**

## 注意事項
1. **フロントエンド互換性**: APIは`grade_id`フィールドを内部的に保持する可能性があるため、テストでも互換性を確認
2. **データ整合性**: 新しい外部キー制約（school_id、position_id等）に対応したテストデータの作成
3. **テストデータベース分離**: 本番データベースとテストデータベースの完全分離
4. **パフォーマンス**: JOINクエリ増加によるレスポンス時間の変化をテストで監視

## 関連Issue
- Issue #003: データベース初期化・初期データ投入（前提条件）
- Issue #004: バックエンドAPI更新（前提条件・完了済み）

## 推定工数
- **設計・準備**: 0.5日
- **メインテスト更新**: 1.0日
- **個別テスト更新**: 1.5日
- **新規テスト作成**: 1.0日
- **統合・CI/CD**: 0.5日
- **テスト・デバッグ**: 1.0日
- **文書更新**: 0.5日

**合計**: 6.0日

## 完了予定日
2025年2月3日（月）

---

**作成日**: 2025年1月26日  
**担当者**: システム開発チーム  
**優先度**: 高（Issue #004完了後の必須作業）
