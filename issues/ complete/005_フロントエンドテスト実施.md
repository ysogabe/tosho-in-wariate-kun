# Issue #005: データベース構造変更に伴うフロントエンドテスト実施

## 概要
データベース構造変更（Issue #003）とバックエンドAPI更新（Issue #004）に伴い、フロントエンド機能への影響を確認するためのテスト実施計画を策定する必要があります。既存のE2Eテストを拡張・更新し、新しいデータベース構造のもとでフロントエンドの正常動作を確保します。

## 背景
新しいデータベース設計では以下の変更が行われています：
- 学校マスタ（schools）の導入
- 役職マスタ（positions）の導入
- クラス構造の変更（grade_idの代わりにschool_id、class_nameの追加）
- 図書委員構造の変更（school_id、position_id等の追加）
- 図書室テーブルが「library_rooms」に変更
- スケジュール関連テーブルの拡張と構造変更

バックエンドAPIの更新では、上記の変更に対応しつつフロントエンド互換性を維持する対応が行われる予定です。そのため、APIの変更がフロントエンド機能に影響を与えないことを確認する必要があります。

## 対応すべきファイル
1. `e2e/specs/*.spec.js` - テスト仕様ファイル
2. `e2e/helpers/setup.js` - テストセットアップヘルパー
3. `e2e/fixtures/test-data.js` - テスト用データ

## タスク

### 1. E2Eテストのセットアップ更新
- [ ] `setup.js`の更新：新しいデータベース構造に対応
  - 新しいスクリプトの呼び出し
  - テストデータの整合性確保
- [ ] テスト用データフィクスチャの更新：
  - 学校マスタに関連するテストデータ追加
  - 役職マスタに関連するテストデータ追加
  - クラスおよび図書委員の構造変更に対応したデータ

### 2. 既存E2Eテストケースの更新
- [ ] `ui-changes.spec.js`の更新：
  - 学校選択UIの確認テスト
  - 役職選択UIの確認テスト
  - クラス一覧テストの更新
- [ ] `weekly-schedule.spec.js`の更新：
  - 学校・学期に基づくフィルターに対応
  - スケジュール表示の検証
- [ ] `schedule-generation.spec.js`の更新：
  - 新しいルールに基づくスケジュール生成の検証
  - 学校・学期に応じたデータ表示の確認

### 3. 新規E2Eテストケースの追加
- [ ] 学校管理画面のテスト実装：
  - 一覧表示確認
  - 追加・編集・削除のテスト
- [ ] 役職管理画面のテスト実装：
  - 一覧表示確認
  - 追加・編集・削除のテスト
- [ ] フロントエンドUIとバックエンドデータモデルの整合性テスト

### 4. テストレポーティングの強化
- [ ] エラー時のデバッグ情報収集
- [ ] テスト結果の詳細レポート作成
- [ ] スクリーンショットの自動キャプチャ

## E2Eテスト実施手順

### 環境準備

```bash
# プロジェクトルートに移動
cd /Users/yoshio/works/tosho-in-wariate-kun

# モックバックエンド環境の準備
cd mock_backend
# 仮想環境が無ければ作成
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# モックバックエンドの起動（別ターミナルで）
cd /Users/yoshio/works/tosho-in-wariate-kun/mock_backend
source venv/bin/activate
flask run --port=5001

# フロントエンドの準備
cd /Users/yoshio/works/tosho-in-wariate-kun/frontend
npm install
npm run dev
```

### テスト実行

```bash
# プロジェクトルートでテスト実行
cd /Users/yoshio/works/tosho-in-wariate-kun
npm run test:e2e

# 特定のテストのみ実行
npx playwright test e2e/specs/ui-changes.spec.js

# UI表示モードで実行（デバッグ用）
npx playwright test --ui

# レポート表示
npx playwright show-report
```

### セットアップスクリプト更新例（`e2e/helpers/setup.js`）

```javascript
async function setupDatabase() {
  console.log('データベースを初期化しています...');
  
  const mockBackendPath = path.resolve(__dirname, '../../mock_backend');
  
  try {
    // データベースファイルを削除
    await execAsync(`cd ${mockBackendPath} && rm -f database.db`);
    console.log('既存のデータベースファイルを削除しました');
    
    // 新しいデータベース初期化スクリプトを実行
    await execAsync(`cd ${mockBackendPath} && source venv/bin/activate && python init_database.py`);
    console.log('データベーステーブルを作成しました');
    
    // シードデータを投入
    await execAsync(`cd ${mockBackendPath} && source venv/bin/activate && python seed_data.py`);
    console.log('シードデータを投入しました');
    
    // テスト特有のデータセットアップ（テスト用追加データ）
    await setupTestSpecificData();
    
    console.log('データベースの初期化が完了しました');
    return true;
  } catch (error) {
    console.error('データベース初期化中にエラーが発生しました:', error);
    return false;
  }
}

// テスト特有のデータセットアップ
async function setupTestSpecificData() {
  // 必要に応じてテスト特有のデータを追加
  const mockBackendPath = path.resolve(__dirname, '../../mock_backend');
  
  try {
    // SQLiteデータベースに直接テストデータを追加するスクリプト
    await execAsync(`cd ${mockBackendPath} && source venv/bin/activate && python -c "
import sqlite3
conn = sqlite3.connect('database.db')
cursor = conn.cursor()

# テスト用のデータ追加（必要に応じて）
# 例：特定のスケジュールや割り当てなど

conn.commit()
conn.close()
print('テスト特有のデータをセットアップしました')
    "`);
    return true;
  } catch (error) {
    console.error('テスト特有データのセットアップに失敗しました:', error);
    return false;
  }
}
```

## テストケースの実装例（`e2e/specs/school-management.spec.js`）

```javascript
// @ts-check
const { test, expect } = require('@playwright/test');
const { setupDatabase } = require('../helpers/setup');

test.describe('学校管理のテスト', () => {
  test.beforeEach(async ({ page }) => {
    // テスト前にデータベースを初期化
    await setupDatabase();
    
    // ログインページにアクセス
    await page.goto('http://localhost:3001/login');
    
    // ログインボタンをクリック
    await page.click('button:has-text("ログイン")');
    
    // ダッシュボードが表示されるまで待機
    await page.waitForURL('**/dashboard');
    
    // 管理画面に移動
    await page.click('a[href="/management"]');
  });

  test('学校一覧の表示と検証', async ({ page }) => {
    // 学校管理に移動（URL調整が必要な場合あり）
    await page.click('text=学校管理');
    
    // 学校一覧が表示されることを確認
    await expect(page.locator('h2:has-text("学校管理")')).toBeVisible();
    
    // 「中央中学校」が一覧に表示されることを確認
    const schoolRow = page.locator('table tbody tr:has-text("中央中学校")');
    await expect(schoolRow).toBeVisible();
    
    // 学期日付が正確に表示されることを確認
    await expect(schoolRow.locator('td:nth-child(3)')).toContainText('2025-04-01');
    await expect(schoolRow.locator('td:nth-child(4)')).toContainText('2025-09-30');
  });

  test('学校の新規追加', async ({ page }) => {
    // 学校管理に移動
    await page.click('text=学校管理');
    
    // 新規追加ボタンをクリック
    await page.click('button:has-text("新規追加")');
    
    // フォームが表示されることを確認
    await expect(page.locator('form')).toBeVisible();
    
    // フォームに入力
    await page.fill('input[name="school_name"]', 'テスト学校');
    await page.fill('input[name="first_term_start"]', '2025-04-10');
    await page.fill('input[name="first_term_end"]', '2025-10-10');
    await page.fill('input[name="second_term_start"]', '2025-10-11');
    await page.fill('input[name="second_term_end"]', '2026-04-09');
    
    // 保存ボタンをクリック
    await page.click('button:has-text("保存")');
    
    // 成功メッセージが表示されることを確認
    await expect(page.locator('text=学校を追加しました')).toBeVisible();
    
    // 一覧に追加した学校が表示されることを確認
    await expect(page.locator('table tbody tr:has-text("テスト学校")')).toBeVisible();
  });
});
```

## 完了基準
1. 全てのE2Eテストが新しいデータベース構造のもとで通過すること
2. フロントエンドのすべての機能が正常に動作することを確認できること
3. エラーケースを含むテストが整備されていること
4. テスト実行手順が明確にドキュメント化されていること
5. CI/CD環境でテストが自動実行できる状態にあること

## 関連資料
- [Issue #003: データベース構造変更対応](./003_データベース構造変更対応.md)
- [Issue #004: バックエンドAPI更新](./004_バックエンドAPI更新.md)
- [データベース設計書](../docs/database_design.md)
- [E2Eテスト仕様](../docs/e2e_test_specification.md)

## 担当者
TBD

## 期限
2025年6月15日

## 備考
1. Issue #003とIssue #004の実装完了後に本テスト作業を開始すること
2. テスト結果をもとに、必要に応じてフロントエンド側のAPI呼び出し部分を修正するIssueを追加で作成すること
3. フロントエンドの機能変更を最小限にとどめる方針で作業を進めること
4. 検証環境でのエンドツーエンドテストを重点的に行い、実稼働前の問題を早期に発見すること
