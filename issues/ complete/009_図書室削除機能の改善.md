# Issue #009: 管理画面の削除機能改善

## 概要

学校基本情報管理の各種管理画面（役員管理、図書室管理、クラス管理など）で、関連するデータがある場合に削除を行うとエラーが発生し、フロントエンドでエラー画面が表示される問題があります。ユーザー体験を向上させるため、エラー画面ではなく適切なメッセージを表示するように改善します。

## 詳細

### 現状の問題

学校基本情報管理の各種管理画面で、関連するデータがある場合に削除を行うと以下のようなエラーが発生します：

```text
Error: この図書室は現在スケジュールで使用されているため削除できません。
    at fetchApi (http://localhost:3000/_next/static/chunks/src_28cf30ba._.js:265:19)
    at async confirmDelete (http://localhost:3000/_next/static/chunks/src_28cf30ba._.js:2031:13)
```

これは図書室管理の例ですが、同様の問題が以下の管理画面でも発生しています：

1. **役員管理**：スケジュールに割り当てられている役員を削除しようとするとエラーが発生
2. **クラス管理**：スケジュールに割り当てられているクラスを削除しようとするとエラーが発生

これらのエラーはバックエンドから返されるエラーメッセージですが、フロントエンドでは適切に処理されず、エラー画面が表示されてしまいます。また、モーダルダイアログが交互に表示される問題もあります。

### 改善目標

1. 全ての管理画面（役員管理、図書室管理、クラス管理など）で、関連するデータがある場合に削除を行うと、ユーザーに分かりやすいエラーメッセージを表示する
2. エラー画面ではなく、適切なエラーメッセージをモーダルやアラートで表示する
3. ユーザーが操作を継続できるようにする
4. モーダルダイアログが交互に表示される問題を解決する

### 影響範囲

- 役員管理の削除機能
- 図書室管理の削除機能
- クラス管理の削除機能
- スケジュール管理機能（関連するデータの扱い）

## 実装計画

1. バックエンドの各種削除APIを確認し、以下の関数を修正する：
   - `delete_library_room`：図書室削除機能
   - `delete_committee_member`：役員削除機能
   - `delete_class`：クラス削除機能
   
2. バックエンドから返されるエラーメッセージを日本語化し、詳細情報を含めるようにする

3. フロントエンドのエラーハンドリングを改善する：
   - `fetchApi`関数のエラーハンドリングを改善
   - エラーメッセージと詳細情報をユーザーフレンドリーなモーダルで表示
   - モーダルダイアログの交互表示問題を解決

## 実装内容

### バックエンドの修正

バックエンドの`delete_library_room`関数を修正し、関連するスケジュール割り当てがある場合は日本語のエラーメッセージを返すようにしました。

```python
# エラーメッセージを日本語化し、詳細情報を追加
return jsonify({
    "error": "この図書室は現在スケジュールで使用されているため削除できません。",
    "details": "関連するスケジュール割り当てを先に削除してください。"
}), 409
```

### フロントエンドの修正

フロントエンドの`deleteLibrary`関数を修正し、エラーメッセージをアラートで表示するようにしました。

```javascript
// レスポンスが成功でない場合
if (!response.ok) {
  // レスポンスのJSONを取得
  const errorData = await response.json().catch(() => ({ 
    error: `API Error: ${response.status} ${response.statusText}` 
  }));
  
  // エラーメッセージをアラートで表示
  if (errorData.error) {
    alert(errorData.error);
    if (errorData.details) {
      alert(errorData.details);
    }
  } else {
    alert(`図書室の削除に失敗しました: ${response.status} ${response.statusText}`);
  }
  
  throw new Error(errorData.error || `API Error: ${response.status} ${response.statusText}`);
}

// 成功した場合、図書室一覧を再取得
await fetchLibraries();
alert('図書室が正常に削除されました');
```

## テスト結果

修正後、図書室の削除機能をテストしたところ、以下の問題が発生しました。

1. フロントエンドではエラーメッセージがアラートで表示されるようになりましたが、モーダルダイアログが交互に表示される問題がありました。
2. エラーメッセージが表示された後、ユーザーが操作を継続できるようになりました。

さらなる改善点：

1. アラートではなく、ユーザーフレンドリーなモーダルダイアログでエラーメッセージを表示するようにする
2. エラーメッセージと詳細情報を一つのモーダルにまとめて表示する

## 優先度

中

## 担当者

未定

## ステータス

一部実装済み
