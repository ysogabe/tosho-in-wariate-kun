# Issue #010: スケジュール生成機能エラー修正

## 概要

管理画面のスケジュール管理から「スケジュール生成」機能を使用すると、APIエラー500が発生し、スケジュールが作成できない問題があります。

## 背景

スケジュール生成機能は、学校の図書室利用スケジュールを自動的に生成するための重要な機能です。現在、この機能を使用すると500エラーが発生し、スケジュールが作成できない状態になっています。

## 発生条件

以下の条件でスケジュール生成を試みると、すべてのケースで失敗します：
- 2025年 前期
- 2025年 後期
- 2026年 前期
- 2026年 後期

データベースは `mock_backend/init_database.py` で初期化されています。

## エラー内容

### フロントエンド側エラー
```
スケジュール生成中にエラーが発生しました: APIエラー: 500

Error: APIエラー: 500
    at generateSchedule (http://localhost:3000/_next/static/chunks/src_app_management_generate-schedule_page_tsx_ee6e5e09._.js:87:23)
```

## 対応すべきファイル

1. `/mock_backend/app.py` - バックエンドAPIのスケジュール生成関連の処理
2. `/frontend/src/app/management/generate-schedule/page.tsx` - フロントエンドのスケジュール生成ページ
3. `/mock_backend/schedule_generator.py` - スケジュール生成ロジック（存在する場合）

## タスク

### 1. バックエンドのエラー調査

- [ ] バックエンドログを確認し、500エラーの原因を特定
- [ ] スケジュール生成APIのエンドポイントを確認
- [ ] スケジュール生成処理の問題箇所を特定

### 2. 修正実装

- [ ] バックエンドのスケジュール生成処理を修正
- [ ] 必要に応じてフロントエンドのエラーハンドリングを改善

### 3. テスト

- [ ] 修正後、各条件でスケジュール生成が正常に動作するか確認
- [ ] 生成されたスケジュールが正しく表示されるか確認

## 期待される結果

スケジュール生成機能が正常に動作し、選択した年度と期間に応じたスケジュールが生成されること。

## 実施結果

### 1. エラー原因の調査

バックエンドログを確認した結果、以下のエラーが発生していることが判明しました：

```sql
sqlite3.IntegrityError: UNIQUE constraint failed: schedules.school_id, schedules.academic_year, schedules.is_first_half, schedules.status
```

このエラーは、スケジュールテーブルに一意制約があり、同じ学校ID、年度、学期（前期/後期）、ステータスの組み合わせが既に存在する場合に発生します。

### 2. 問題箇所

`schedule_generator.py` の以下の2つの関数に問題がありました：

1. `create_schedule` 関数：スケジュールを作成する際に既存のドラフトスケジュールを削除していましたが、既存のアクティブなスケジュールが存在する場合に一意制約違反が発生していました。

2. `generate` 関数：スケジュールをアクティブに更新する際に、既存のアクティブなスケジュールを非アクティブにする処理に問題がありました。

### 3. 修正内容

以下の修正を実施しました：

1. `create_schedule` 関数：既存のドラフトスケジュールを削除してから新しいスケジュールを作成するように修正しました。

2. `generate` 関数：既存のアクティブなスケジュールを検索して非アクティブに更新してから、新しいスケジュールをアクティブに更新するように修正しました。

### 4. テスト結果

修正後、以下の条件でスケジュール生成をテストし、すべて正常に動作することを確認しました：

- 2025年 前期：正常に生成され、既存のスケジュールが非アクティブになり、新しいスケジュールがアクティブになりました。
- 2029年 前期（新規）：正常に生成され、スケジュールがアクティブになりました。

### 5. 最終修正内容（2025/5/27更新）

以下の修正を実施しました：

1. **`generate` 関数の修正**：
   - 既存のすべてのスケジュールを削除する方式から、より安全なアプローチに変更
   - 新しいスケジュールを作成後、既存のアクティブなスケジュールを`inactive`ステータスに変更
   - 新しいスケジュールを`active`ステータスに設定

2. **`create_schedule` 関数の修正**：
   - ドラフトスケジュールに関連する`schedule_assignments`も適切に削除
   - 外部キー制約を考慮した削除順序に変更

### 6. 最終テスト結果（2025/5/27実施）

修正後、以下のテストを実施し、すべて正常に動作することを確認しました：

#### APIレベルテスト
- **2025年度前期**: ✅ 正常に生成（schedule_id: 2）
- **2025年度後期**: ✅ 正常に生成（schedule_id: 3）
- **2025年度前期（再生成）**: ✅ 正常に生成（schedule_id: 4、既存スケジュールが適切に非アクティブ化）

#### フロントエンドE2Eテスト
- **Playwright自動テスト**: ✅ 正常に動作（2026年度前期での生成確認）
- **使用ポート**: フロントエンド 3100、バックエンド 5100
- **API接続**: 正常に動作（5100ポートへの接続確認）

### 7. 結論

スケジュール生成機能のエラーは、データベースの一意制約違反によるものでした。既存のスケジュールを適切に処理し、アクティブステータスの管理を改善することで問題を解決しました。

**修正内容**：
1. 既存アクティブスケジュールの適切な非アクティブ化
2. ドラフトスケジュールの関連データを含む完全削除
3. 一意制約違反の回避

これにより、スケジュール生成機能が正常に動作し、複数回の生成にも対応できるようになりました。

### 8. 最終動作確認（2025/5/27完了）

ユーザーによる実際の動作確認を実施し、以下を確認しました：

#### 確認環境
- **フロントエンド**: http://localhost:3100
- **バックエンド**: http://localhost:5100
- **データベース**: 初期化済み（図書委員8名、図書室2室登録済み）

#### 確認結果
- ✅ **スケジュール生成ページアクセス**: 正常に表示
- ✅ **年度・学期選択**: ドロップダウンが正常に動作
- ✅ **スケジュール生成実行**: エラーなく完了
- ✅ **成功メッセージ表示**: 「スケジュールが正常に生成されました」が表示
- ✅ **複数回生成**: 同条件での再生成が正常に動作（既存スケジュールの適切な置き換え）

#### 結論
**Issue #010は完全に解決され、スケジュール生成機能が期待通りに動作することを確認しました。**
