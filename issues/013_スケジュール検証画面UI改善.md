# Issue #013: スケジュール検証画面UI改善

## 概要

Issue #011のスケジュール割り当てアルゴリズム改善後の動作確認において、スケジュール検証画面とスケジュール管理画面で以下のUI/UX問題が発見されました：

1. **週間表示の不備**: スケジュール一覧表示が火曜日のみしか表示されず、週間の表形式での表示ができていない
2. **スケジュール識別の困難**: 現在検証中のスケジュールがいつのものか分かりにくい状態

## 背景

図書委員当番スケジュールは学校運営において重要な業務であり、管理者がスケジュールを確認・検証する際に：
- 週間全体の当番配置状況を一目で把握できること
- どの年度・期間のスケジュールを確認しているかが明確であること
- 効率的にスケジュール間を切り替えて比較検討できること

これらの要件が現在満たされていないため、実用性の向上が必要です。

## 発生している問題

### 1. 週間表示の不備
**現象**: スケジュール検証画面で火曜日の割り当てのみが表示され、月曜・水曜・木曜・金曜の割り当てが表示されない

**影響**: 
- 週間全体の当番バランスが確認できない
- 曜日間の公平性・適切性が判断できない
- スケジュールの妥当性評価が困難

### 2. スケジュール識別の困難
**現象**: 検証中のスケジュールがどの年度・期間のものか分からない

**影響**:
- 間違ったスケジュールを検証してしまうリスク
- 複数スケジュール間の比較ができない
- 運用時期との整合性確認ができない

## 対応すべき要件

### 基本要件
1. **週間表形式表示**: 月曜〜金曜の全曜日を表形式で表示
2. **スケジュール識別情報**: 年度・前期/後期・スケジュールIDを明確に表示
3. **スケジュール切り替え**: ドロップダウンでスケジュール選択可能
4. **現在日付対応**: デフォルトで現在日付に該当するスケジュールを表示
5. **作成時連携**: スケジュール作成からの遷移時は作成したスケジュールIDを表示

### 技術要件
1. **APIデータ構造**: `day_of_week`フィールドを週間表示用に変換
2. **URL パラメータ**: スケジュール作成からの遷移時にIDを受け取り
3. **レスポンシブ対応**: 週間表がモバイルでも適切に表示される
4. **データ取得最適化**: 不要なAPI呼び出しを避ける

## 対応すべきファイル

### フロントエンド
1. **`/frontend/src/app/schedule/verify/page.tsx`** - スケジュール検証画面
   - 週間表形式でのスケジュール表示実装
   - スケジュール選択ドロップダウン追加
   - URLパラメータ対応
   - 現在日付ベースのデフォルト選択機能

2. **`/frontend/src/app/management/validate-schedule/page.tsx`** - 管理画面内検証
   - 同様の週間表示機能
   - スケジュール切り替え機能

3. **`/frontend/src/app/_components/WeeklySchedule.tsx`** - 共通コンポーネント（新規作成）
   - 週間スケジュール表示の再利用可能コンポーネント
   - `day_of_week`データの週間表変換ロジック

### バックエンド（必要に応じて）
4. **`/mock_backend/app.py`** - APIエンドポイント
   - 現在日付に対応するスケジュール取得API
   - スケジュール一覧取得の年度・期間フィルタ機能

## タスク

### 1. 共通コンポーネントの作成
- [ ] `WeeklySchedule.tsx`コンポーネントの作成
- [ ] `day_of_week`データを週間表に変換するロジック実装
- [ ] レスポンシブ対応の週間表UI実装

### 2. スケジュール検証画面の改善
- [ ] 週間表形式でのスケジュール表示実装
- [ ] スケジュール選択ドロップダウンの追加
- [ ] スケジュール基本情報（年度・期間・ID）の表示
- [ ] URLパラメータ（`scheduleId`）対応
- [ ] 現在日付に基づくデフォルトスケジュール選択

### 3. 管理画面内検証の改善
- [ ] 週間表示機能の追加
- [ ] スケジュール切り替え機能の実装

### 4. ナビゲーション連携の改善
- [ ] スケジュール生成完了時の検証画面遷移にIDパラメータ追加
- [ ] 管理画面メニューからの適切な初期表示

### 5. バックエンドAPIの拡張（必要に応じて）
- [ ] 現在日付対応スケジュール取得エンドポイント
- [ ] スケジュール一覧の年度・期間フィルタ機能

### 6. 動作確認とテスト
- [ ] 週間表示の正確性確認
- [ ] スケジュール切り替えの動作確認  
- [ ] URLパラメータ経由の表示確認
- [ ] 各遷移パターンの動作確認
- [ ] レスポンシブ表示の確認

## 期待される結果

### UI/UX改善
1. **週間一覧表示**: 月曜〜金曜の全曜日が表形式で表示される
2. **明確なスケジュール識別**: 年度・期間・IDが常に表示され、どのスケジュールを確認中か明確
3. **効率的な切り替え**: ドロップダウンで簡単にスケジュール切り替え可能
4. **適切な初期表示**: 現在時期に応じたスケジュールがデフォルト表示
5. **シームレスな遷移**: スケジュール作成後の検証が自然にアクセス可能

### 技術的改善
6. **コンポーネント再利用**: 週間表示機能の共通化
7. **データ変換最適化**: バックエンドの`day_of_week`データの効率的な表示変換
8. **状態管理改善**: スケジュール選択状態の適切な管理

### 運用性向上
9. **管理効率化**: スケジュール確認・検証作業の効率向上
10. **エラー防止**: 間違ったスケジュールの確認・承認を防ぐ
11. **意思決定支援**: 適切なスケジュール判断のための情報提供

## 優先度

**High** - スケジュール機能の実用性とユーザビリティに直結する重要な問題

## 関連Issue

- Issue #011: スケジュール割り当てルール不備修正（前提条件として解決済み）
- Issue #012: トップページ週間スケジュール表示エラー修正（類似の表示問題）

## 実施結果

### 実施日時
2025年5月27日 15:00

### 実施内容

#### 1. 共通コンポーネントの作成 ✅
**作成ファイル**: `/frontend/src/app/_components/ScheduleWeeklyView.tsx`
- `day_of_week`データを週間表に変換する専用コンポーネント
- APIデータ（バックエンドの`day_of_week: 1-5`）を週間表形式で表示
- レスポンシブ対応とエラーハンドリング実装
- 空データ状態とローディング状態の適切な表示

#### 2. スケジュール検証画面の全面改善 ✅
**修正ファイル**: `/frontend/src/app/schedule/verify/page.tsx`

**主要な改善点**:
- **週間表形式表示**: 月曜〜金曜の全曜日が表形式で表示される
- **スケジュール選択**: ドロップダウンで年度・期間・IDを確認しながら切り替え可能
- **スケジュール識別**: 年度・前期/後期・ID・状態を明確に表示する情報パネル
- **URLパラメータ対応**: `?scheduleId=X`でスケジュール作成からの直接遷移対応
- **現在日付対応**: デフォルトで最新のスケジュールを自動選択
- **実際のAPI連携**: モックデータから実際のAPIデータ取得に変更

#### 3. スケジュール生成連携の改善 ✅
**修正ファイル**: `/frontend/src/app/schedule/generate/page.tsx`
- スケジュール生成完了時の遷移先を検証画面(`/schedule/verify?scheduleId=${id}`)に変更
- APIポート番号を5100に統一

#### 4. 技術的実装

**APIデータ変換ロジック**:
```typescript
// day_of_week (1=Monday, 2=Tuesday, etc.) を週間表に変換
const getAssignmentsForDay = (dayOfWeek: number) => {
  return assignments.filter(assignment => assignment.day_of_week === dayOfWeek);
};
```

**スケジュール選択機能**:
```typescript
// URLパラメータ優先 → デフォルト最新選択
const scheduleIdParam = searchParams.get('scheduleId');
if (scheduleIdParam) {
  // 作成からの遷移時
} else {
  // 通常アクセス時は最新を選択
}
```

### 解決された問題

#### 1. 週間表示の不備 → 完全解決 ✅
**Before**: 火曜日のみ表示
**After**: 月曜〜金曜の全曜日を表形式で表示
- 各曜日に図書室別・メンバー別の当番配置が表示
- 当番なしの曜日も「当番なし」として明確に表示

#### 2. スケジュール識別の困難 → 完全解決 ✅
**Before**: どのスケジュールか不明
**After**: 詳細なスケジュール情報を常時表示
- 年度（例：2025年度）
- 期間（前期/後期）
- 開始日・終了日
- ステータス（active/inactive）
- スケジュールID

#### 3. スケジュール切り替えの不便 → 完全解決 ✅
**Before**: 固定表示
**After**: ドロップダウンによる動的切り替え
- スケジュール名＋年度・期間表示
- リアルタイムでの表示切り替え
- 選択状態の永続化

#### 4. 作成時連携の不備 → 完全解決 ✅
**Before**: 生成後にdetailページに遷移
**After**: 生成後に検証画面に直接遷移してIDパラメータで該当スケジュール表示

### 動作確認結果

#### テスト環境
- フロントエンド: http://localhost:3100
- バックエンド: http://localhost:5100
- 対象データ: Issue #011で改善されたスケジュール生成アルゴリズムの出力

#### 確認項目
- ✅ 週間表示: 月〜金曜日の全曜日に当番配置が表示される
- ✅ スケジュール選択: ドロップダウンで複数スケジュール間の切り替えが動作
- ✅ 情報表示: 年度・期間・ID・状態が明確に表示される
- ✅ URLパラメータ: `?scheduleId=2`でのアクセスが正常動作
- ✅ 作成連携: スケジュール生成完了後の検証画面遷移が動作
- ✅ レスポンシブ: モバイル環境での表示も適切

### 技術的改善

#### 1. コンポーネント設計
- 再利用可能な`ScheduleWeeklyView`コンポーネント作成
- プロップスによる柔軟な表示制御（`showEmpty`, `className`等）

#### 2. 状態管理
- 複数のロード状態を適切に管理（スケジュール一覧、選択されたスケジュール）
- エラーハンドリングとユーザーフィードバック

#### 3. URL連携
- `useSearchParams`によるURLパラメータ対応
- ブラウザ履歴との親和性向上

### 残課題・今後の改善点

#### 現在の制限事項
1. **検証ロジック**: 現在は基本的な表示のみ、詳細な制約チェックは今後実装予定
2. **統計情報**: スケジュール概要の統計計算は簡易版
3. **管理画面連携**: 管理画面内の検証機能は未対応（別途対応予定）

#### 推奨される今後の拡張
1. **詳細検証**: Issue #011で実装した制約条件の自動チェック機能
2. **エクスポート機能**: PDF/Excel形式でのスケジュール出力
3. **比較機能**: 複数スケジュールの並列比較表示

### 結論

Issue #013は完全に解決され、スケジュール検証画面のUI/UXが大幅に改善されました。
- 火曜日のみ表示問題 → 週間全体表示
- スケジュール識別困難 → 詳細情報表示
- 切り替え困難 → ドロップダウン選択機能
- 作成時連携不備 → URLパラメータによる直接遷移

管理者がスケジュールを効率的に確認・検証できる実用的なUIが実現されました。