# Issue #010: スケジュール生成機能エラー修正

## 概要

管理画面のスケジュール管理から「スケジュール生成」機能を使用すると、APIエラー500が発生し、スケジュールが作成できない問題があります。

## 背景

スケジュール生成機能は、学校の図書室利用スケジュールを自動的に生成するための重要な機能です。現在、この機能を使用すると500エラーが発生し、スケジュールが作成できない状態になっています。

## 発生条件

以下の条件でスケジュール生成を試みると、すべてのケースで失敗します：
- 2025年 前期
- 2025年 後期
- 2026年 前期
- 2026年 後期

データベースは `mock_backend/init_database.py` で初期化されています。

## エラー内容

### フロントエンド側エラー
```
スケジュール生成中にエラーが発生しました: APIエラー: 500

Error: APIエラー: 500
    at generateSchedule (http://localhost:3000/_next/static/chunks/src_app_management_generate-schedule_page_tsx_ee6e5e09._.js:87:23)
```

## 対応すべきファイル

1. `/mock_backend/app.py` - バックエンドAPIのスケジュール生成関連の処理
2. `/frontend/src/app/management/generate-schedule/page.tsx` - フロントエンドのスケジュール生成ページ
3. `/mock_backend/schedule_generator.py` - スケジュール生成ロジック（存在する場合）

## タスク

### 1. バックエンドのエラー調査

- [ ] バックエンドログを確認し、500エラーの原因を特定
- [ ] スケジュール生成APIのエンドポイントを確認
- [ ] スケジュール生成処理の問題箇所を特定

### 2. 修正実装

- [ ] バックエンドのスケジュール生成処理を修正
- [ ] 必要に応じてフロントエンドのエラーハンドリングを改善

### 3. テスト

- [ ] 修正後、各条件でスケジュール生成が正常に動作するか確認
- [ ] 生成されたスケジュールが正しく表示されるか確認

## 期待される結果

スケジュール生成機能が正常に動作し、選択した年度と期間に応じたスケジュールが生成されること。

## 実施結果

### 1. エラー原因の調査

バックエンドログを確認した結果、以下のエラーが発生していることが判明しました：

```sql
sqlite3.IntegrityError: UNIQUE constraint failed: schedules.school_id, schedules.academic_year, schedules.is_first_half, schedules.status
```

このエラーは、スケジュールテーブルに一意制約があり、同じ学校ID、年度、学期（前期/後期）、ステータスの組み合わせが既に存在する場合に発生します。

### 2. 問題箇所

`schedule_generator.py` の以下の2つの関数に問題がありました：

1. `create_schedule` 関数：スケジュールを作成する際に既存のドラフトスケジュールを削除していましたが、既存のアクティブなスケジュールが存在する場合に一意制約違反が発生していました。

2. `generate_schedule_with_class` 関数：スケジュールIDが返されない場合の処理に問題があり、正しくスケジュールが生成されていませんでした。

3. APIエンドポイントの実装にも問題があり、`start_date`と`end_date`の値が正しく保存・更新されていませんでした。

### 3. 修正内容

#### バックエンド修正

1. **スケジュールAPIの修正**
   - `add_schedule`関数を修正して、`start_date`と`end_date`の値をデータベースに保存するようにしました
   - 同じ条件（`school_id`、`academic_year`、`is_first_half`）のスケジュールが既に存在する場合は、新しいスケジュールを作成する前に削除するロジックを追加しました
   - 日付の計算ロジックを改善し、リクエストで提供された日付を優先的に使用するようにしました

2. **データベーススキーマの修正**
   - `schedules`テーブルに`start_date`と`end_date`のカラムを追加しました
   - `db_setup.py`ファイルも修正して、テスト用のデータベースにも同じカラムが追加されるようにしました

3. **エラーハンドリングの改善**
   - `get_schedule`関数と`update_schedule`関数にエラーハンドリングを追加し、`start_date`と`end_date`のカラムが存在しない場合でもエラーにならないようにしました
   - 例外処理を改善し、エラーが発生した場合はロールバックするようにしました

4. **`generate_schedule_with_class`関数の修正**
   - スケジュールIDが返されない場合に、最新のスケジュールを取得するロジックを追加しました
   - エラーハンドリングを改善し、より詳細なエラーメッセージを返すようにしました

### 4. テスト結果

修正後、以下のテストを実施し、すべて正常に動作することを確認しました：

1. **API単体テスト**
   - `test_api_schedules.py`のすべてのテストが正常に通過
   - スケジュールの作成、取得、更新、削除が正しく動作

2. **スケジュール生成テスト**
   - `test_schedule_generator.py`のテストが正常に通過
   - 同じ条件でスケジュールを再生成しても一意制約違反が発生しない
   - 生成されたスケジュールが正しく保存され、取得できる

## 結論

スケジュール生成機能のエラーを修正し、安定して動作するようになりました。主な改善点は以下の通りです：

1. 同じ条件のスケジュールが既に存在する場合は、新しいスケジュールを作成する前に削除するようにしました
2. データベーススキーマを拡張し、日付情報を正しく保存・更新できるようにしました
3. エラーハンドリングを改善し、より堅牢な実装にしました

これにより、スケジュール生成機能が正常に動作し、ユーザーは年度と期間に応じたスケジュールを問題なく生成できるようになりました。

### 3. 修正内容

以下の修正を実施しました：

1. `create_schedule` 関数：既存のドラフトスケジュールを削除してから新しいスケジュールを作成するように修正しました。

2. `generate` 関数：既存のアクティブなスケジュールを検索して非アクティブに更新してから、新しいスケジュールをアクティブに更新するように修正しました。

### 4. テスト結果

修正後、以下の条件でスケジュール生成をテストし、すべて正常に動作することを確認しました：

- 2025年 前期：正常に生成され、既存のスケジュールが非アクティブになり、新しいスケジュールがアクティブになりました。
- 2029年 前期（新規）：正常に生成され、スケジュールがアクティブになりました。

### 5. 結論

スケジュール生成機能のエラーは、データベースの一意制約違反によるものでした。既存のスケジュールを適切に処理することで問題を解決しました。これにより、スケジュール生成機能が正常に動作するようになりました。
