# Issue #003: データベース構造変更対応

## 概要
データベース設計書（database_design.md）が更新されたため、mock_backendにあるデータベース初期化スクリプトと初期データ投入スクリプトを更新する必要があります。新しいスキーマ設計に合わせてデータベース関連のスクリプトを修正し、整合性を確保します。実装にあたっては、最新の設計書をしっかりと確認し、すべての変更点を正確に反映させてください。

## 背景
最新のデータベース設計では以下の変更が行われました：
- 学校マスタ（schools）の導入
- 前期・後期の学期管理
- 役職マスタ（positions）の導入
- クラス構造の変更（grade_idの代わりにschool_id、class_nameの追加）
- スケジュール関連テーブルの拡張
- 全テーブルにcreated_atとupdated_atカラムの追加

現在のmock_backendのスクリプトは旧設計に基づいており、これらの変更を反映していないため更新が必要です。

## 対応すべきファイル
1. `mock_backend/init_database.py` - データベース初期化スクリプト
2. `mock_backend/db_setup.py` - データベースセットアップスクリプト
3. `mock_backend/seed_data.py` - 初期データ投入スクリプト

## タスク

### 1. データベース設計書の確認
- [ ] 最新のデータベース設計書（`docs/database_design.md`）を詳細に確認
- [ ] 各テーブルの構造、関連、制約を理解
- [ ] ER図を参照してテーブル間の関係性を把握
- [ ] ビジネスルールと制約を適切に実装するための要件確認

### 2. テーブル構造の更新
- [ ] データベース設計書に合わせてテーブル定義を更新する
  - schools（学校マスタ）テーブルの作成
  - positions（役職マスタ）テーブルの作成
  - classes（クラスマスタ）テーブル構造の更新
  - committee_members（図書委員マスタ）テーブル構造の更新
  - library_rooms（図書室マスタ）テーブル構造の更新
  - schedules（スケジュールマスタ）テーブル構造の更新
  - schedule_assignments（スケジュール割当）テーブル構造の更新

### 3. 外部キー制約の更新
- [ ] 各テーブル間の関係を適切に設定
- [ ] 必要な制約（UNIQUE, NOT NULL等）の追加

### 3. 初期データの更新
- [ ] 学校マスタに初期データを追加
- [ ] 役職マスタに初期データを追加
- [ ] クラスマスタのデータ構造更新
- [ ] 図書委員データの構造更新
- [ ] 図書室データの構造更新
- [ ] スケジュールデータの構造更新

### 4. 既存機能との整合性確認
- [ ] API呼び出しの確認
- [ ] テストケースの更新
- [ ] スケジュール生成機能の動作確認

## コード変更例：init_database.py

```python
# schools テーブル
cursor.execute('''
CREATE TABLE schools (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    school_name TEXT NOT NULL,
    first_term_start DATE,
    first_term_end DATE,
    second_term_start DATE,
    second_term_end DATE,
    active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
)
''')

# positions テーブル
cursor.execute('''
CREATE TABLE positions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    position_name TEXT NOT NULL,
    description TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
)
''')

# classes テーブル
cursor.execute('''
CREATE TABLE classes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    school_id INTEGER NOT NULL,
    grade INTEGER NOT NULL,
    class_number INTEGER NOT NULL,
    class_name TEXT NOT NULL,
    homeroom_teacher TEXT,
    active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (school_id) REFERENCES schools (id) ON DELETE RESTRICT
)
''')

# 必要なインデックスの作成
cursor.execute('CREATE UNIQUE INDEX idx_schools_name ON schools (school_name)')
cursor.execute('CREATE UNIQUE INDEX idx_positions_name ON positions (position_name)')
cursor.execute('CREATE UNIQUE INDEX idx_classes_school_grade_class_number ON classes (school_id, grade, class_number)')
cursor.execute('CREATE UNIQUE INDEX idx_classes_school_class_name ON classes (school_id, class_name)')
```

## コード変更例：seed_data.py

```python
# 学校テーブル初期データ
cursor.execute('''
INSERT INTO schools (school_name, first_term_start, first_term_end, second_term_start, second_term_end)
VALUES ('中央中学校', '2025-04-01', '2025-09-30', '2025-10-01', '2026-03-31')
''')

# 役職テーブル初期データ
positions_data = [
    ('委員長', '図書委員会の代表者'),
    ('副委員長', '委員長の補佐'),
    ('書記', '書記')
]
cursor.executemany("INSERT INTO positions (position_name, description) VALUES (?, ?)", positions_data)
```

## 完了基準
1. データベース設計書の内容が正確にmock_backendのスクリプトに反映されていること
2. 新しいテーブル構造でデータベースが正常に初期化できること
3. 初期データが適切に投入されること
4. 既存の機能との互換性が確保されていること
5. 単体テストとAPIテストがパスすること

## 関連資料
- [データベース設計書](../docs/database_design.md)
- [システム設計書](../docs/system_design.md)
- [実装計画書](../docs/implementation_plan.md)

## 担当者
TBD

## 期限
2025年6月5日

## 備考
テーブル構造を変更するため、既存のAPIと連携している部分についても影響範囲を確認し、必要に応じて修正を行うこと。
