# Test Specification Document

# --- Grade Management ---
feature: "Grade Management"
description: "Allows administrators to manage school grades (学年)."
scenarios:
  - name: "View list of grades"
    given: "Admin is on the Grade Management page (/management/grades)"
    when: "The page loads"
    then: "A list of grades is displayed, each showing ID, Name (学年名), and Description (説明)"
    priority: High
    type: Functional
    tags: [grade, read]

  - name: "Add a new grade"
    given: "Admin is on the Grade Management page and opens the new grade form"
    when: "Admin enters a valid name (e.g., '7年生') and description (e.g., '新しい学年') and clicks 'Save'"
    then: "The new grade appears in the list of grades with the entered details, and a success message is shown"
    priority: High
    type: Functional
    tags: [grade, create]

  - name: "Add a new grade with missing name"
    given: "Admin is on the Grade Management page and opens the new grade form"
    when: "Admin enters a description but no name and clicks 'Save'"
    then: "An error message is displayed, and the grade is not added"
    priority: Medium
    type: Functional
    tags: [grade, create, validation]

  - name: "Edit an existing grade"
    given: "Admin is on the Grade Management page and a grade (e.g., '1年生') exists"
    when: "Admin clicks 'Edit' for the grade, changes its name (e.g., to '1年生 Advanced') and description, and clicks 'Save'"
    then: "The grade's details are updated in the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [grade, update]

  - name: "Delete a grade (not associated with any class)"
    given: "Admin is on the Grade Management page and a grade exists that is not linked to any class"
    when: "Admin clicks 'Delete' for the grade and confirms the action"
    then: "The grade is removed from the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [grade, delete]
  
  - name: "Attempt to delete a grade (associated with a class)"
    given: "Admin is on the Grade Management page and a grade exists that IS linked to at least one class"
    when: "Admin clicks 'Delete' for the grade and confirms the action"
    then: "An error message is displayed indicating the grade cannot be deleted due to existing associations, and the grade remains in the list"
    priority: Medium
    type: Functional
    tags: [grade, delete, validation]

# --- Class Management ---
feature: "Class Management"
description: "Allows administrators to manage school classes (クラス), associating them with grades."
scenarios:
  - name: "View list of classes"
    given: "Admin is on the Class Management page (/management/classes)"
    when: "The page loads"
    then: "A list of classes is displayed, each showing ID, Class Name (クラス名), and associated Grade Name (学年名)"
    priority: High
    type: Functional
    tags: [class, read]

  - name: "Add a new class"
    given: "Admin is on the Class Management page, opens the new class form, and at least one grade exists"
    when: "Admin enters a valid name (e.g., '3組'), selects an existing grade (e.g., '1年生'), and clicks 'Save'"
    then: "The new class appears in the list with the entered details and associated grade name, and a success message is shown"
    priority: High
    type: Functional
    tags: [class, create]

  - name: "Add a new class with missing name"
    given: "Admin is on the Class Management page and opens the new class form"
    when: "Admin selects a grade but provides no class name and clicks 'Save'"
    then: "An error message is displayed, and the class is not added"
    priority: Medium
    type: Functional
    tags: [class, create, validation]

  - name: "Add a new class without selecting a grade"
    given: "Admin is on the Class Management page and opens the new class form"
    when: "Admin enters a class name but does not select a grade and clicks 'Save'"
    then: "An error message is displayed (assuming grade is mandatory), and the class is not added"
    priority: Medium
    type: Functional
    tags: [class, create, validation]

  - name: "Edit an existing class"
    given: "Admin is on the Class Management page and a class (e.g., '1年1組') exists"
    when: "Admin clicks 'Edit' for the class, changes its name (e.g., to '1年A組') and/or associated grade, and clicks 'Save'"
    then: "The class's details are updated in the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [class, update]

  - name: "Delete a class (not associated with any committee member)"
    given: "Admin is on the Class Management page and a class exists that is not linked to any committee member"
    when: "Admin clicks 'Delete' for the class and confirms the action"
    then: "The class is removed from the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [class, delete]

  - name: "Attempt to delete a class (associated with committee members)"
    given: "Admin is on the Class Management page and a class exists that IS linked to committee members"
    when: "Admin clicks 'Delete' for the class and confirms the action"
    then: "An error message is displayed indicating the class cannot be deleted due to existing associations, and the class remains in the list"
    priority: Medium
    type: Functional
    tags: [class, delete, validation]

# --- Committee Member Management ---
feature: "Committee Member Management"
description: "Allows administrators to manage committee members (図書委員), associating them with classes and roles."
scenarios:
  - name: "View list of committee members"
    given: "Admin is on the Committee Member Management page (/management/committee-members)"
    when: "The page loads"
    then: "A list of members is displayed, each showing ID, Name (名前), Role (役割), Class Name (クラス名), and Grade Name (学年名)"
    priority: High
    type: Functional
    tags: [committee_member, read]

  - name: "Add a new committee member"
    given: "Admin is on the Committee Member Management page, opens the new member form, and at least one class exists"
    when: "Admin enters a valid name (e.g., '図書 太郎'), selects an existing class, selects a role (e.g., '委員長'), and clicks 'Save'"
    then: "The new member appears in the list with all details, and a success message is shown"
    priority: High
    type: Functional
    tags: [committee_member, create]

  - name: "Add a new committee member with missing required fields"
    given: "Admin is on the Committee Member Management page and opens the new member form"
    when: "Admin clicks 'Save' without filling name or selecting a class"
    then: "An error message is displayed, and the member is not added"
    priority: Medium
    type: Functional
    tags: [committee_member, create, validation]

  - name: "Edit an existing committee member"
    given: "Admin is on the Committee Member Management page and a member exists"
    when: "Admin clicks 'Edit' for the member, changes their name, class, or role, and clicks 'Save'"
    then: "The member's details are updated in the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [committee_member, update]

  - name: "Delete a committee member (not associated with any schedule assignments)"
    given: "Admin is on the Committee Member Management page and a member exists not linked to assignments"
    when: "Admin clicks 'Delete' for the member and confirms"
    then: "The member is removed from the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [committee_member, delete]
  
  - name: "Attempt to delete a committee member (associated with schedule assignments)"
    given: "Admin is on the Committee Member Management page and a member exists who IS linked to schedule assignments"
    when: "Admin clicks 'Delete' for the member and confirms"
    then: "An error message is displayed indicating the member cannot be deleted, and the member remains in the list"
    priority: Medium
    type: Functional
    tags: [committee_member, delete, validation]

# --- Library Management ---
feature: "Library Management"
description: "Allows administrators to manage libraries (図書室), including their availability."
scenarios:
  - name: "View list of libraries"
    given: "Admin is on the Library Management page (/management/libraries)"
    when: "The page loads"
    then: "A list of libraries is displayed, each showing Name (図書室名), Location (場所), Capacity (定員), Active Status (状態), and Availability Times (利用可能時間)"
    priority: High
    type: Functional
    tags: [library, read]

  - name: "Add a new library with availability"
    given: "Admin is on the Library Management page and opens the new library form"
    when: "Admin enters valid details (name, location, capacity, active status) and adds one or more valid availability slots (day, open time, close time) and clicks 'Save'"
    then: "The new library appears in the list with all details including availability, and a success message is shown"
    priority: High
    type: Functional
    tags: [library, create]

  - name: "Add a new library with invalid availability (e.g., end time before open time)"
    given: "Admin is on the Library Management page and opens the new library form"
    when: "Admin enters library details and an availability slot where close_time is before open_time, then clicks 'Save'"
    then: "A form-level error message is displayed (or backend rejects), and the library/availability is not saved as such. (Backend might save library but not the invalid slot, or reject all - depends on backend validation)"
    priority: Medium
    type: Functional
    tags: [library, create, validation]
  
  - name: "Edit an existing library's details and availability"
    given: "Admin is on the Library Management page and a library exists"
    when: "Admin clicks 'Edit', changes details (e.g., name, capacity, is_active), adds a new availability slot, modifies an existing one, and deletes another, then clicks 'Save'"
    then: "The library's details and its availability are updated in the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [library, update]

  - name: "Delete a library (not associated with any schedule assignments)"
    given: "Admin is on the Library Management page and a library exists not linked to schedule assignments"
    when: "Admin clicks 'Delete' for the library and confirms"
    then: "The library is removed from the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [library, delete]

  - name: "Attempt to delete a library (associated with schedule assignments)"
    given: "Admin is on the Library Management page and a library exists that IS linked to schedule assignments"
    when: "Admin clicks 'Delete' for the library and confirms"
    then: "An error message is displayed indicating the library cannot be deleted, and the library remains in the list"
    priority: Medium
    type: Functional
    tags: [library, delete, validation]

# --- Schedule Rule Management ---
feature: "Schedule Rule Management"
description: "Allows administrators to manage schedule generation rules (スケジュールルール)."
scenarios:
  - name: "View list of schedule rules"
    given: "Admin is on the Schedule Rule Management page (/management/schedule-rules)"
    when: "The page loads"
    then: "A list of rules is displayed, sorted by priority, each showing Priority (優先度), Name (ルール名), Description (説明), and Type (タイプ)"
    priority: High
    type: Functional
    tags: [schedule_rule, read]

  - name: "Add a new schedule rule"
    given: "Admin is on the Schedule Rule Management page and opens the new rule form"
    when: "Admin enters valid details (name, description, type, priority) and clicks 'Save'"
    then: "The new rule appears in the list, sorted by priority, and a success message is shown"
    priority: High
    type: Functional
    tags: [schedule_rule, create]

  - name: "Add a new schedule rule with missing required fields"
    given: "Admin is on the Schedule Rule Management page and opens the new rule form"
    when: "Admin clicks 'Save' without filling name, type, or priority"
    then: "A form-level error message is displayed, and the rule is not added"
    priority: Medium
    type: Functional
    tags: [schedule_rule, create, validation]

  - name: "Edit an existing schedule rule"
    given: "Admin is on the Schedule Rule Management page and a rule exists"
    when: "Admin clicks 'Edit' for the rule, changes its details (e.g., name, description, type, priority), and clicks 'Save'"
    then: "The rule's details are updated in the list (and list re-sorts if priority changed), and a success message is shown"
    priority: High
    type: Functional
    tags: [schedule_rule, update]

  - name: "Delete a schedule rule"
    given: "Admin is on the Schedule Rule Management page and a rule exists"
    when: "Admin clicks 'Delete' for the rule and confirms"
    then: "The rule is removed from the list, and a success message is shown"
    priority: High
    type: Functional
    tags: [schedule_rule, delete]

# --- Weekly Schedule Display ---
feature: "Weekly Schedule Display"
description: "Allows users to view the weekly schedule assignments."
scenarios:
  - name: "View weekly schedule for the default (first) schedule"
    given: "User navigates to the Weekly Schedule page (/schedule/weekly) and schedules exist"
    when: "The page loads"
    then: "The schedule for the current week, for the first available schedule, is displayed, showing assignments for each day, including time slot, library, and assigned members"
    priority: High
    type: Functional
    tags: [schedule_display, read]

  - name: "Change selected schedule"
    given: "User is on the Weekly Schedule page and multiple schedules are available in the dropdown"
    when: "User selects a different schedule from the dropdown"
    then: "The weekly display updates to show assignments for the newly selected schedule for the current week"
    priority: High
    type: Functional
    tags: [schedule_display, read]

  - name: "Navigate to previous/next/current week"
    given: "User is on the Weekly Schedule page with a schedule selected"
    when: "User clicks 'Previous Week', 'Next Week', or 'This Week' button"
    then: "The schedule display updates to show assignments for the corresponding week"
    priority: High
    type: Functional
    tags: [schedule_display, navigation]

  - name: "View schedule for a day with assignments"
    given: "User is viewing a week with known assignments for a specific day"
    when: "The schedule for that week is displayed"
    then: "Assignments for that day are shown correctly under the date, with time, library, and member names"
    priority: High
    type: Functional
    tags: [schedule_display, read]

  - name: "View schedule for a day with no assignments"
    given: "User is viewing a week where a specific day has no assignments"
    when: "The schedule for that week is displayed"
    then: "The cell for that day indicates '当番なし' (No Duty) or is empty"
    priority: Medium
    type: Functional
    tags: [schedule_display, read]

  - name: "Loading state for schedules list"
    given: "User navigates to the Weekly Schedule page"
    when: "The list of schedules is being fetched"
    then: "A loading indicator for the schedule dropdown is shown (e.g., 'スケジュールを読み込み中...')"
    priority: Medium
    type: UI
    tags: [schedule_display, loading]

  - name: "Loading state for assignments"
    given: "User is on the Weekly Schedule page and selects a schedule or changes week"
    when: "The assignments for the selected schedule/week are being fetched"
    then: "A loading indicator for the schedule grid is shown (e.g., '割り当てを読み込み中...')"
    priority: Medium
    type: UI
    tags: [schedule_display, loading]

  - name: "Error state if fetching schedules list fails"
    given: "User navigates to the Weekly Schedule page"
    when: "Fetching the list of schedules fails"
    then: "An error message is displayed (e.g., 'スケジュールの取得に失敗しました。')"
    priority: High
    type: Functional
    tags: [schedule_display, error_handling]

  - name: "Error state if fetching assignments fails"
    given: "User is on the Weekly Schedule page and has selected a schedule"
    when: "Fetching the assignments for that schedule fails"
    then: "An error message is displayed (e.g., '割り当ての取得に失敗しました。')"
    priority: High
    type: Functional
    tags: [schedule_display, error_handling]
```
