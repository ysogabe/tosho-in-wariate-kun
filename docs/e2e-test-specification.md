# E2Eテスト仕様書

## 概要

図書委員当番くん（Tosho-in Wariate-kun）のE2Eテスト仕様書です。本ドキュメントは現在利用可能なすべての画面と、それぞれのE2Eテスト項目を定義しています。

**作成日**: 2025-01-05

**対象バージョン**: Next.js 15 + TypeScript + shadcn/ui

**テストブラウザ**: Chrome, Firefox, Safari (推奨)

**解像度**: デスクトップ (1920x1080)、タブレット (768x1024)、モバイル (375x667)

---

## 0. E2Eテスト環境構築前提作業

### 0.1 インフラストラクチャ準備

#### データベース環境
- **テスト専用データベースの設定**

  ```bash
  # テスト用データベース作成
  cp .env.local .env.test
  # DATABASE_URLをテスト用に変更
  DATABASE_URL="file:./test.db"
  ```

- **テストデータベースの初期化**

  ```bash
  NODE_ENV=test npx prisma migrate deploy
  NODE_ENV=test npx prisma db seed
  ```

- **テストデータのクリーンアップスクリプト**

  ```bash
  # テスト前後のデータリセット
  NODE_ENV=test npx prisma migrate reset --force
  ```

#### 認証・セッション管理

- **NextAuth.js テスト設定**

  ```typescript
  // jest.setup.js または専用設定ファイル
  process.env.NEXTAUTH_URL = 'http://localhost:3000'
  process.env.NEXTAUTH_SECRET = 'test-secret-key'
  ```

- **テスト用認証プロバイダー設定**

  ```typescript
  // テスト用プロバイダー（Credentials）
  providers: [
    CredentialsProvider({
      id: 'test-credentials',
      credentials: {
        email: { type: 'email' },
        password: { type: 'password' }
      }
    })
  ]
  ```

#### 環境変数設定

- **必須環境変数の確認**

  ```bash
  # .env.test ファイル作成
  DATABASE_URL="file:./test.db"
  NEXTAUTH_URL="http://localhost:3000"
  NEXTAUTH_SECRET="test-secret-key-for-e2e"
  NODE_ENV="test"
  ```

### 0.2 E2Eテストツール導入

#### Playwright セットアップ
- **インストール**

  ```bash
  npm install -D @playwright/test
  npx playwright install
  ```

- **設定ファイル作成**

  ```typescript
  // playwright.config.ts
  import { defineConfig } from '@playwright/test'
  
  export default defineConfig({
    testDir: './e2e',
    timeout: 30000,
    use: {
      baseURL: 'http://localhost:3000',
      trace: 'on-first-retry',
      screenshot: 'only-on-failure'
    },
    projects: [
      { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
      { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
      { name: 'webkit', use: { ...devices['Desktop Safari'] } }
    ]
  })
  ```

#### CI/CD パイプライン設定
- **GitHub Actions設定**

  ```yaml
  # .github/workflows/e2e.yml
  name: E2E Tests
  on: [push, pull_request]
  jobs:
    e2e:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
        - run: npm ci
        - run: npm run build
        - run: npx playwright install
        - run: npm run test:e2e
  ```

### 0.3 モックサービス設定

#### 外部API モック
- **MSW (Mock Service Worker) 導入**

  ```bash
  npm install -D msw
  ```

- **API モックハンドラー作成**

  ```typescript
  // e2e/mocks/handlers.ts
  import { rest } from 'msw'
  
  export const handlers = [
    rest.get('/api/classes', (req, res, ctx) => {
      return res(ctx.json(mockClassesData))
    })
  ]
  ```

#### メール送信モック
- **メール送信機能のモック設定**

  ```typescript
  // テスト環境でのメール送信無効化
  if (process.env.NODE_ENV === 'test') {
    mockEmailService = true
  }
  ```

### 0.4 パフォーマンス・監視設定

#### ログ収集
- **テスト実行時のログ設定**

  ```typescript
  // ブラウザコンソールログの収集
  page.on('console', (msg) => {
    if (msg.type() === 'error') {
      console.error('Browser Error:', msg.text())
    }
  })
  ```

#### エラー追跡
- **未処理エラーの検出**

  ```typescript
  // 未処理のPromise rejection検出
  page.on('pageerror', (error) => {
    console.error('Page Error:', error.message)
  })
  ```

### 0.5 セキュリティ設定

#### HTTPS設定（本番環境）
- **SSL証明書の設定確認**
- **リダイレクト設定の確認**

#### Content Security Policy
- **CSP設定の確認とテスト環境での調整**

#### レート制限
- **テスト環境でのレート制限無効化**

  ```typescript
  // テスト環境でのレート制限バイパス
  if (process.env.NODE_ENV === 'test') {
    rateLimitEnabled = false
  }
  ```

### 0.6 データ管理

#### テストデータ準備
- **サンプルデータの自動生成**

  ```bash
  # テストデータシーディング
  npm run db:seed:test
  ```

- **テストケースごとのデータ分離**

  ```typescript
  // テストケース開始時のデータ準備
  beforeEach(async () => {
    await resetTestDatabase()
    await seedTestData()
  })
  ```

#### データクリーンアップ
- **テスト後のデータ削除**

  ```typescript
  // テスト完了後のクリーンアップ
  afterEach(async () => {
    await cleanupTestData()
  })
  ```

### 0.7 パフォーマンステスト設定

#### Core Web Vitals 測定
- **LCP, FID, CLS の測定設定**

  ```typescript
  // Lighthouseを使用したパフォーマンステスト
  import lighthouse from 'lighthouse'
  
  const result = await lighthouse(url, {
    onlyCategories: ['performance'],
    output: 'json'
  })
  ```

#### リソース監視
- **メモリ使用量の監視**
- **ネットワーク使用量の監視**

### 0.8 必要なパッケージ一覧

```json
{
  "devDependencies": {
    "@playwright/test": "^1.40.0",
    "msw": "^2.0.0",
    "lighthouse": "^11.0.0",
    "cross-env": "^7.0.3"
  }
}
```

### 0.9 事前チェックリスト

#### インフラ準備確認

- [ ] テスト用データベースが正常に動作する
- [ ] 認証システムがテスト環境で動作する
- [ ] 環境変数が正しく設定されている
- [ ] E2Eテストツールが正常にインストールされている

#### セキュリティ確認

- [ ] テスト用認証情報が本番環境と分離されている
- [ ] テストデータに実際の個人情報が含まれていない
- [ ] テスト環境が本番データにアクセスできない

#### パフォーマンス確認

- [ ] テスト実行時間が適切な範囲内である
- [ ] CI/CDパイプラインでのリソース使用量が適切である
- [ ] 並列実行時の競合状態がない

---

## 1. プロダクション画面

### 1.1 ホームページ (`/`)

**画面の目的**: システムの概要紹介とメインランディングページ

**アクセス方法**:

- ブラウザで `http://localhost:3000/` にアクセス
- 認証不要

**確認要素**:

- ページタイトル: "図書委員当番くん Next.js 15 + TypeScript"
- メインタイトル: "図書委員当番割り当て自動化システム"
- 4つの機能紹介カード（管理、当番表、公平性、学校対応）

**E2Eテスト項目**:

#### 1.1.1 基本表示テスト

- [ ] ページが正常に読み込まれること
- [ ] メインタイトルが表示されること
- [ ] 4つの機能紹介カードすべてが表示されること
- [ ] レスポンシブデザインが正常に動作すること

#### 1.1.2 インタラクションテスト

- [ ] 機能カードのホバーエフェクトが動作すること
- [ ] 矢印アニメーションが正常に動作すること
- [ ] ダークモード切り替えが正常に動作すること（該当する場合）

#### 1.1.3 レスポンシブテスト

- [ ] デスクトップ表示（1920x1080）で4列グリッドが表示されること
- [ ] タブレット表示（768x1024）で適切にレイアウトが調整されること
- [ ] モバイル表示（375x667）で縦積みレイアウトになること

---

### 1.2 ログインページ (`/auth/login`)

**画面の目的**: ユーザー認証とシステムへのアクセス

**アクセス方法**:

- ブラウザで `http://localhost:3000/auth/login` にアクセス
- ホームページからのナビゲーション（該当する場合）

**確認要素**:

- システムロゴとタイトル
- ログインフォーム（メールアドレス、パスワード）
- システム機能紹介（4つの特徴カード）
- フッターリンク（プライバシーポリシー、利用規約）

**E2Eテスト項目**:

#### 1.2.1 画面表示テスト

- [ ] ページが正常に読み込まれること
- [ ] システムロゴとタイトルが表示されること
- [ ] ログインフォームが表示されること
- [ ] システム紹介セクションが表示されること
- [ ] フッターリンクが表示されること

#### 1.2.2 フォーム操作テスト

- [ ] メールアドレス入力フィールドが正常に動作すること
- [ ] パスワード入力フィールドが正常に動作すること（マスク表示）
- [ ] パスワード表示/非表示トグルが動作すること
- [ ] ログインボタンがクリック可能であること

#### 1.2.3 バリデーションテスト

- [ ] 空のメールアドレスでエラーメッセージが表示されること
- [ ] 無効なメールアドレス形式でエラーメッセージが表示されること
- [ ] 空のパスワードでエラーメッセージが表示されること
- [ ] 短すぎるパスワードでエラーメッセージが表示されること

#### 1.2.4 認証テスト

- [ ] 有効な認証情報でログインが成功すること
- [ ] 無効な認証情報でエラーメッセージが表示されること
- [ ] ログイン処理中にローディング状態が表示されること

#### 1.2.5 ナビゲーションテスト

- [ ] フッターリンクが正しいページに遷移すること
- [ ] 成功ログイン後に適切なページにリダイレクトすること

---

### 1.3 権限エラーページ (`/unauthorized`)

**画面の目的**: 権限のないユーザーへの適切なエラー表示

**アクセス方法**:

- ブラウザで `http://localhost:3000/unauthorized` に直接アクセス
- 権限のない状態で保護されたページにアクセス

**確認要素**:

- エラーメッセージ
- ナビゲーションオプション
- ホームページまたはログインページへのリンク

**E2Eテスト項目**:

#### 1.3.1 基本表示テスト

- [ ] ページが正常に読み込まれること
- [ ] 適切なエラーメッセージが表示されること
- [ ] ナビゲーションオプションが表示されること

#### 1.3.2 ナビゲーションテスト

- [ ] ホームページへのリンクが正常に動作すること
- [ ] ログインページへのリンクが正常に動作すること
- [ ] ブラウザの戻るボタンが正常に動作すること

---

## 2. 開発・テスト画面

### 2.1 データベース接続テスト (`/test-db`)

**画面の目的**: データベース接続の状態確認

**アクセス方法**:

- ブラウザで `http://localhost:3000/test-db` にアクセス

**E2Eテスト項目**:

#### 2.1.1 接続状態テスト

- [ ] データベース接続状態が表示されること
- [ ] SQLite接続が成功していることが確認できること
- [ ] NextAuth.js設定状態が表示されること

---

### 2.2 コンポーネントテスト (`/components-test`)

**画面の目的**: 共通UIコンポーネントの動作確認

**アクセス方法**:

- ブラウザで `http://localhost:3000/components-test` にアクセス

**確認要素**:

- ローディングスピナー（Small, Medium, Large）
- テーブルローディング
- カードローディング
- エラーバウンダリー
- 確認ダイアログ（基本、削除、リセット）
- アイコン（異なるサイズ、アプリアイコン）
- ページネーション

**E2Eテスト項目**:

#### 2.2.1 ローディングコンポーネントテスト

- [ ] 3サイズのローディングスピナーが表示されること
- [ ] テーブルローディングアニメーションが動作すること
- [ ] カードローディングアニメーションが動作すること

#### 2.2.2 エラーバウンダリーテスト

- [ ] エラー表示ボタンが正常に動作すること
- [ ] エラーバウンダリーでエラーがキャッチされること
- [ ] エラー非表示ボタンが正常に動作すること

#### 2.2.3 確認ダイアログテスト

- [ ] 基本ダイアログが正常に開閉すること
- [ ] 削除ダイアログが正常に開閉すること
- [ ] リセットダイアログが正常に開閉すること
- [ ] 各ダイアログの確認・キャンセルボタンが動作すること

#### 2.2.4 アイコンテスト

- [ ] 異なるサイズのアイコンが正常に表示されること
- [ ] アプリ専用アイコンが正常に表示されること

#### 2.2.5 ページネーションテスト

- [ ] ページ番号変更が正常に動作すること
- [ ] ページサイズ変更が正常に動作すること
- [ ] ページ情報が正確に表示されること

---

### 2.3 テーブルテスト (`/table-test`)

**画面の目的**: DataTableコンポーネントの動作確認

**アクセス方法**:

- ブラウザで `http://localhost:3000/table-test` にアクセス

**確認要素**:

- 概要カード（クラス総数、図書委員総数、選択数）
- クラス管理テーブル
- 図書委員管理テーブル
- 検索・ソート・フィルタ機能

**E2Eテスト項目**:

#### 2.3.1 概要表示テスト

- [ ] 4つの概要カードが正常に表示されること
- [ ] 統計数値が正確に表示されること
- [ ] アクティブ/非アクティブ数が正確に表示されること

#### 2.3.2 クラステーブルテスト

- [ ] クラスデータが正常に表示されること
- [ ] 検索機能が正常に動作すること
- [ ] ソート機能が正常に動作すること
- [ ] 行選択機能が正常に動作すること
- [ ] 選択数が概要カードに反映されること

#### 2.3.3 図書委員テーブルテスト

- [ ] 図書委員データが正常に表示されること
- [ ] 検索機能が正常に動作すること
- [ ] ソート機能が正常に動作すること
- [ ] 行選択機能が正常に動作すること
- [ ] 選択数が概要カードに反映されること

#### 2.3.4 レスポンシブテスト

- [ ] モバイル表示でテーブルが適切にスクロールすること
- [ ] タブレット表示で適切なレイアウトが保たれること

---

### 2.4 認証テスト (`/auth-test`)

⚠️ **セキュリティ警告**: このページにはテスト用認証情報が含まれています

**画面の目的**: 認証システムの動作確認

**アクセス方法**:

- ブラウザで `http://localhost:3000/auth-test` にアクセス

**E2Eテスト項目**:

#### 2.4.1 認証状態テスト

- [ ] 現在の認証状態が表示されること
- [ ] テストログイン機能が動作すること
- [ ] ログアウト機能が動作すること

---

### 2.5 ログインフォームテスト (`/login-test`)

**画面の目的**: ログインフォームコンポーネントの単体テスト

**アクセス方法**:

- ブラウザで `http://localhost:3000/login-test` にアクセス

**E2Eテスト項目**:

#### 2.5.1 フォーム機能テスト

- [ ] ログインフォームが正常に表示されること
- [ ] フォーム送信が正常に動作すること
- [ ] エラーハンドリングが正常に動作すること

---

### 2.6 UIテスト (`/test-ui`)

**画面の目的**: shadcn/uiコンポーネントライブラリの動作確認

**アクセス方法**:

- ブラウザで `http://localhost:3000/test-ui` にアクセス

**E2Eテスト項目**:

#### 2.6.1 UIコンポーネントテスト

- [ ] ボタンコンポーネントが正常に表示されること
- [ ] 入力フィールドが正常に動作すること
- [ ] カードコンポーネントが正常に表示されること
- [ ] テーマ/カラーパレットが正常に適用されること

---

## 3. 共通テスト項目

### 3.1 パフォーマンステスト

- [ ] ページ読み込み時間が3秒以内であること
- [ ] JavaScript実行エラーがないこと
- [ ] コンソールエラーがないこと

### 3.2 アクセシビリティテスト

- [ ] キーボードナビゲーションが正常に動作すること
- [ ] スクリーンリーダー対応が適切であること
- [ ] コントラスト比が適切であること

### 3.3 SEOテスト

- [ ] 適切なページタイトルが設定されていること
- [ ] メタディスクリプションが設定されていること（該当ページ）
- [ ] 適切なヘッディング構造であること

### 3.4 セキュリティテスト

- [ ] XSS攻撃に対する適切な防御があること
- [ ] 認証が必要なページで適切にリダイレクトされること
- [ ] セッション管理が適切に動作すること

---

## 4. テストデータ

### 4.1 サンプルデータ

- **テストユーザー**: `/auth-test` ページ参照（開発環境のみ）
- **サンプルクラス**: `/table-test` ページに表示されるデータ
- **サンプル図書委員**: `/table-test` ページに表示されるデータ

### 4.2 テスト環境

- **開発環境**: `http://localhost:3000`
- **データベース**: SQLite (開発環境)
- **認証**: NextAuth.js

---

## 5. テスト実行手順

### 5.1 事前準備

1. 開発サーバーを起動: `npm run dev`
2. データベースの初期化: `npx prisma migrate dev`
3. テストデータの確認: `/test-db` ページでデータベース接続確認

### 5.2 テスト実行順序

1. **基本機能テスト**: ホームページ → ログインページ
2. **認証テスト**: ログイン → 権限エラー → ログアウト
3. **UI/UXテスト**: 各テストページでコンポーネント動作確認
4. **統合テスト**: エンドツーエンドのユーザーフロー確認

### 5.3 E2Eテストツール推奨設定

- **Playwright**: 推奨E2Eテストフレームワーク
- **Cypress**: 代替テストフレームワーク
- **テストブラウザ**: Chrome, Firefox, Safari
- **レポート形式**: HTML, JSON

---

## 6. 今後の拡張予定

### 6.1 実装予定の画面

- 管理者ダッシュボード
- クラス管理ページ
- 図書委員管理ページ
- 当番表生成・表示ページ
- スケジュール管理ページ

### 6.2 追加予定のテスト項目

- API統合テスト
- データ永続化テスト
- 印刷機能テスト
- エクスポート機能テスト

---

**最終更新**: 2025-01-05

**次回レビュー予定**: 新機能実装時
