# 図書委員当番割り当てシステム 第二フェーズ実装計画書

## 1. 実装範囲

概要設計書に基づき、第二フェーズでは以下の機能を実装します：

### 1.1 基本情報管理機能の拡張
- 基本情報一括インポート機能の実装
  - 学年・クラス情報一括インポート (1.1.3)
  - 図書委員一括インポート (1.2.2)
  - インポート用テンプレートの提供
  - データバリデーション
  - エラーハンドリング
- 委員情報変更・休会管理 (1.2.3)

### 1.2 スケジュール生成・管理機能の拡張
- 例外ルール設定 (2.1.2)
- 当番交代管理 (2.3.2)
- 欠席対応管理 (2.3.3)
- 公平性検証 (2.4.2)

### 1.3 ユーザー機能の拡張
- 当番交代申請 (3.2.2)
- スケジュール変更通知 (3.3.2)

### 1.4 出力・レポート機能の拡張
- クラス別当番表示 (4.1.3)
- 当番実績レポート (4.2.1)
- スケジュールエクスポート (4.3.1)
- 印刷用フォーマット出力 (4.3.2)

## 2. 実装スケジュール

| 週 | 実装内容 |
|---|---|
| 第1週 | データインポート機能の実装（画面からの登録に加え、CSVによる一括インポート機能） |
| 第2週 | 委員情報変更・休会管理機能の実装 |
| 第3週 | スケジュール例外ルール設定、公平性検証機能の実装 |
| 第4週 | 当番交代管理、欠席対応管理機能の実装 |
| 第5週 | 当番交代申請、スケジュール変更通知機能の実装 |
| 第6週 | クラス別当番表示、当番実績レポート機能の実装 |
| 第7週 | スケジュールエクスポート機能、印刷機能、手動調整機能の実装 |
| 第8週 | テスト、バグ修正、ドキュメント作成 |

## 3. システム拡張内容

### 3.1 データインポート機能の拡張

#### 3.1.1 CSVインポート機能
- CSVファイルフォーマット定義
- バリデーション機能
- エラーハンドリング（エラーログ出力）
- 一括登録処理

#### 3.1.2 テンプレートダウンロード機能
- 各種データ用のCSVテンプレート提供
- 記入例・ガイドライン付きテンプレート

### 3.2 委員情報変更・休会管理機能

#### 3.2.1 休会管理
- 休会期間設定
- 休会中の当番自動調整
- 休会履歴管理

#### 3.2.2 委員情報変更
- 委員変更履歴管理
- 変更に伴うスケジュール自動調整
- 変更前後の情報比較表示

### 3.3 スケジュール調整機能の拡張

#### 3.3.1 例外ルール設定
- 特定委員に対する例外条件設定
- 特定曜日・図書室に対する例外条件設定
- 例外ルールの優先度管理

#### 3.3.2 当番交代管理
- 交代申請ワークフロー
- 申請承認・却下機能
- 交代履歴管理
- 交代状況ダッシュボード

#### 3.3.3 欠席対応管理
- 緊急欠席登録
- 代替委員自動提案
- 欠席通知機能
- 欠席履歴管理

### 3.4 レポート・出力機能の拡張

#### 3.4.1 クラス別当番表示
- クラス単位でのスケジュール表示
- クラス間比較機能
- クラス担任向け出力形式

#### 3.4.2 当番実績レポート
- 期間別集計機能
- 委員別・クラス別・学年別集計
- グラフ表示（棒グラフ、円グラフ）
- トレンド分析

#### 3.4.3 スケジュールエクスポート
- 複数形式対応（CSV、Excel、PDF）
- カスタム出力項目設定
- ヘッダー・フッターカスタマイズ
- 定期エクスポート設定

## 4. 機能詳細設計

### 4.1 データインポート機能

#### 4.1.1 インポートフロー
1. テンプレートダウンロード
2. CSVファイル選択・アップロード
3. データ検証（必須項目、形式、重複チェック）
4. エラー表示・修正機会提供
5. 確認画面表示
6. インポート実行
7. 結果表示

#### 4.1.2 エラーハンドリング
- 行番号指定によるエラー表示
- エラー種別の明確な提示
- 部分的なインポートオプション
- エラーログのダウンロード機能

### 4.2 当番交代・欠席管理機能

#### 4.2.1 交代申請ワークフロー
1. 委員による交代申請（日付、理由入力）
2. 候補となる交代可能委員の表示
3. 交代先委員の選択または自動提案
4. 委員長による一次承認（オプション）
5. 教員による最終承認
6. 関係者への通知
7. スケジュール自動更新

#### 4.2.2 欠席管理ワークフロー
1. 欠席登録（緊急性フラグ付き）
2. 代替候補委員の自動提案
3. 代替委員の選択・依頼
4. 承認・確定
5. 関係者への通知
6. 欠席履歴への記録

### 4.3 公平性検証機能

#### 4.3.1 検証指標
- 委員別当番回数
- 曜日別分布
- 図書室別分布
- 特定条件（水曜・金曜日など）の分布
- 期間内の負荷バランス

#### 4.3.2 検証レポート
- 全体統計
- 偏りのある委員のハイライト
- 改善提案
- 比較チャート

## 5. API拡張設計

### 5.1 データインポート関連API

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス |
|--------------|--------|------|-----------|-----------|
| /api/import/template/:type | GET | インポートテンプレート取得 | type (grades, classes, members) | テンプレートCSV |
| /api/import/:type | POST | データインポート | CSV, オプション | インポート結果 |
| /api/import/validate | POST | インポート前検証 | CSV, type | 検証結果 |

### 5.2 委員情報変更・休会関連API

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス |
|--------------|--------|------|-----------|-----------|
| /api/members/:id/leave | POST | 休会登録 | 期間、理由 | 登録結果 |
| /api/members/:id/leave/:leaveId | PUT | 休会情報更新 | 更新情報 | 更新結果 |
| /api/members/:id/history | GET | 委員変更履歴取得 | - | 履歴リスト |

### 5.3 スケジュール調整関連API

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス |
|--------------|--------|------|-----------|-----------|
| /api/schedules/exceptions | GET | 例外ルール一覧取得 | - | 例外ルールリスト |
| /api/schedules/exceptions | POST | 例外ルール登録 | ルール情報 | 登録結果 |
| /api/schedules/swaps | GET | 交代申請一覧取得 | ?status | 交代申請リスト |
| /api/schedules/swaps | POST | 交代申請登録 | 申請情報 | 登録結果 |
| /api/schedules/swaps/:id | PUT | 交代申請更新（承認/却下） | ステータス、コメント | 更新結果 |
| /api/schedules/absences | POST | 欠席登録 | 欠席情報 | 登録結果 |
| /api/schedules/absences/:id/substitute | GET | 代替候補取得 | ?date | 候補者リスト |

### 5.4 レポート関連API

| エンドポイント | メソッド | 説明 | リクエスト | レスポンス |
|--------------|--------|------|-----------|-----------|
| /api/reports/classes/:id | GET | クラス別スケジュール取得 | ?period | クラススケジュール |
| /api/reports/performance | GET | 当番実績レポート取得 | 期間、集計単位 | 実績データ |
| /api/reports/fairness | GET | 公平性分析取得 | 期間 | 分析結果 |
| /api/export/schedule | POST | スケジュールエクスポート | 期間、形式、オプション | エクスポートファイル |

## 6. フロントエンド拡張設計

### 6.1 新規コンポーネント

#### 6.1.1 データインポート関連
- `ImportWizard`: インポートウィザードコンポーネント
- `CsvValidator`: CSV検証・エラー表示コンポーネント
- `ImportResultView`: インポート結果表示コンポーネント

#### 6.1.2 委員情報管理関連
- `MemberHistoryView`: 委員変更履歴表示コンポーネント
- `LeaveManagementForm`: 休会管理フォームコンポーネント
- `MemberComparisonView`: 変更前後比較コンポーネント

#### 6.1.3 スケジュール調整関連
- `ExceptionRuleBuilder`: 例外ルール構築コンポーネント
- `SwapRequestFlow`: 交代申請フローコンポーネント
- `AbsenceManagementPanel`: 欠席管理パネルコンポーネント
- `SubstituteSelector`: 代替委員選択コンポーネント

#### 6.1.4 レポート関連
- `ClassScheduleView`: クラス別スケジュール表示コンポーネント
- `PerformanceChart`: 実績チャートコンポーネント
- `FairnessAnalysisView`: 公平性分析表示コンポーネント
- `ExportConfigPanel`: エクスポート設定パネルコンポーネント

## 7. テスト計画

### 7.1 単体テスト拡張

- CSVパーサー・バリデーターのテスト
- 例外ルール適用ロジックのテスト
- 交代・欠席管理ロジックのテスト
- レポート生成ロジックのテスト

### 7.2 統合テスト拡張

- インポートフロー全体のテスト
- 交代申請〜承認〜スケジュール反映フローのテスト
- 欠席登録〜代替委員確定フローのテスト
- レポート生成〜エクスポートフローのテスト

### 7.3 ユーザー受け入れテスト

- 実際のデータを用いたインポートテスト
- 実際のユースケースに基づく交代・欠席シナリオテスト
- 実際の学校環境での出力・レポート確認テスト

## 8. まとめ

第二フェーズでは、第一フェーズで実装した基本機能を拡張し、より実用的なシステムへと進化させます。特に、データ管理の効率化（一括インポート）、運用中の柔軟な対応（交代・欠席管理）、そして実績分析（レポート機能）に焦点を当てています。これにより、日々の運用をよりスムーズにし、教員の負担をさらに軽減するとともに、スケジュールの質と公平性の向上を図ります。
